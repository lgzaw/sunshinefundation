<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunshine Foundations</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="./styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <i class="fas fa-gem logo-icon"></i>
            <span>Sunshine Foundations</span>
        </div>
        
        <!-- Header Navigation for wide screens -->
        <div class="header-nav" id="headerNav">
            <div class="header-nav-item active" data-bulletin="1">Our Mission</div>
            <div class="header-nav-item" data-bulletin="2">Our Timelines</div>
            <div class="header-nav-item" data-bulletin="3">Our History</div>
            <div class="header-nav-item" data-bulletin="4">Our Members</div>
            <div class="header-nav-item" data-bulletin="5">Our Clubs</div>
            <div class="header-nav-item" data-bulletin="6">Branches</div>
            <div class="header-nav-item" data-bulletin="7">Commendations</div>
            <div class="header-nav-item" data-bulletin="8">Partners and Supporters</div>
            <div class="header-nav-item" data-bulletin="9">Contacts</div>
        </div>
        
        <div class="header-actions">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search...">
            </div>
            
            <!-- Mobile Menu Button (visible only on narrow screens) -->
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
            
            <button class="signin-btn" id="signinBtn">
                <i class="fas fa-sign-in-alt"></i> Sign In
            </button>
        </div>
    </header>
    
    <!-- Side Menu for Mobile -->
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <h3><i class="fas fa-gem"></i> Bulletin Boards</h3>
        </div>
        <div class="side-menu-items">
          <div class="header-nav-item active" data-bulletin="1">Our Mission</div>
            <div class="header-nav-item" data-bulletin="2">Our Timelines</div>
            <div class="header-nav-item" data-bulletin="3">Our History</div>
            <div class="header-nav-item" data-bulletin="4">Our Members</div>
            <div class="header-nav-item" data-bulletin="5">Our Clubs</div>
            <div class="header-nav-item" data-bulletin="6">Branches</div>
            <div class="header-nav-item" data-bulletin="7">Commendations</div>
            <div class="header-nav-item" data-bulletin="8">Partners and Supporters</div>
            <div class="header-nav-item" data-bulletin="9">Contacts</div>
        </div>
    </div>
    
    <!-- Menu Overlay -->
    <div class="menu-overlay" id="menuOverlay"></div>
    
    <!-- Compact Horizontal Necklace Navigation -->
    <div class="necklace-container">
        <div class="necklace-string"></div>
        <div class="necklace-track" id="necklaceTrack">
            <!-- Pearls will be added dynamically by JavaScript -->
        </div>
    </div>
    
    <!-- Necklace Controls -->
    <div class="necklace-controls">
        <button class="nav-arrow" id="prevBtn">
            <i class="fas fa-chevron-left"></i>
        </button>
        
        <div class="necklace-indicator">
            <span>Bulletin</span>
            <span class="current" id="currentBulletin">1</span>
            <span>of 8</span>
        </div>
        
        <button class="nav-arrow" id="nextBtn">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    
    <!-- Main Display Area -->
    <div class="display-area">
        <div class="display-header">
            <div class="display-title">
                <div class="display-title-icon">
                    <i class="fas fa-bullhorn"></i>
                </div>
                <span id="displayTitle">Our Mission</span>
            </div>
            <div id="bulletinIndicator" style="font-size: 0.9rem; opacity: 0.9;">Active Display</div>
        </div>
        
        <div class="display-content" id="displayContent">
            <div class="bulletin-1">
                <div class="scrolling-bg"></div>
                <div class="story-display">
                    <h3 class="mb-2">Compact Horizontal Necklace Navigation</h3>
                    <p class="mb-2">This navigation places the <strong>active bulletin in the center</strong> with the other bulletins arranged horizontally around it like pearls on a necklace.</p>
                    <p class="mb-2">The center pearl is larger and highlighted, showing it's the active bulletin. Only 3-5 bulletins are visible at a time for a clean, compact look.</p>
                    <p>Click on any pearl to bring it to the center, or use the arrow buttons to rotate the necklace. The necklace automatically rotates every 15 seconds.</p>
                </div>
                <div class="number-display">
                    <div>8</div>
                    <div class="number-label">Bulletins</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>Navigation</h4>
                <ul class="footer-links">
                    <li><a href="#" data-bulletin="1">Bulletin 1 - Welcome</a></li>
                    <li><a href="#" data-bulletin="2">Bulletin 2 - Year Stories</a></li>
                    <li><a href="#" data-bulletin="3">Bulletin 3 - More Stories</a></li>
                    <li><a href="#" data-bulletin="4">Bulletin 4 - Mixed Content</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h4>Card Collections</h4>
                <ul class="footer-links">
                    <li><a href="#" data-bulletin="5">Bulletin 5 - 46 Cards</a></li>
                    <li><a href="#" data-bulletin="6">Bulletin 6 - 7 Cards</a></li>
                    <li><a href="#" data-bulletin="7">Bulletin 7 - 21 Cards</a></li>
                    <li><a href="#" data-bulletin="8">Bulletin 8 - Contact</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h4>Platform</h4>
                <ul class="footer-links">
                    <li><a href="#" id="adminLinkFooter">Admin Dashboard</a></li>
                    <li><a href="#" id="clubLinkFooter">Club Access</a></li>
                    <li><a href="#">JSON Database</a></li>
                    <li><a href="#">Responsive Design</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h4>Connect</h4>
                <ul class="footer-links">
                    <li><a href="#" data-bulletin="8">Contact Page</a></li>
                    <li><a href="#">Donation Info</a></li>
                    <li><a href="#">Volunteer Portal</a></li>
                    <li><a href="#">Help & Support</a></li>
                </ul>
            </div>
        </div>
        
        <div class="footer-bottom">
            &copy; 2023 CenterNecklace Platform. Active bulletin is always displayed in the center.
        </div>
    </footer>
    
    <!-- Sign-in Modal -->
    <div class="modal-overlay" id="signinModal">
        <div class="signin-modal" style="background: white; border-radius: 15px; width: 90%; max-width: 450px; overflow: hidden; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);">
            <div class="display-header" style="border-radius: 0;">
                <div class="display-title">
                    <div class="display-title-icon">
                        <i class="fas fa-lock"></i>
                    </div>
                    <span>Secure Sign In</span>
                </div>
                <button id="closeModal" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            
            <div style="padding: 2rem;">
                <div style="display: flex; border-bottom: 2px solid #eee; margin-bottom: 2rem;">
                    <button class="signin-tab-btn active" data-tab="admin" style="flex: 1; padding: 1rem; background: none; border: none; border-bottom: 3px solid var(--accent); font-weight: 600; color: var(--primary); cursor: pointer;">
                        <i class="fas fa-user-shield"></i> Admin
                    </button>
                    <button class="signin-tab-btn" data-tab="club" style="flex: 1; padding: 1rem; background: none; border: none; font-weight: 600; color: var(--gray); cursor: pointer;">
                        <i class="fas fa-users"></i> Club
                    </button>
                </div>
                
                <!-- Admin Sign-in -->
                <div id="adminSigninForm">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Admin Username</label>
                        <input type="text" class="form-input" id="adminUsername" placeholder="Enter admin username" style="width: 100%; padding: 0.9rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Password</label>
                        <input type="password" class="form-input" id="adminPassword" placeholder="Enter password" style="width: 100%; padding: 0.9rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                    </div>
                    
                    <button class="btn btn-primary btn-block" id="adminSigninBtn">
                        <i class="fas fa-sign-in-alt"></i> Sign In as Admin
                    </button>
                    
                    <p style="text-align: center; margin-top: 1.5rem; color: var(--gray); font-size: 0.9rem;">
                        Demo: Use "admin" as username and any password
                    </p>
                </div>
                
                <!-- Club Sign-in -->
                <div id="clubSigninForm" class="hidden">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Club ID or Username</label>
                        <input type="text" class="form-input" id="clubId" placeholder="Enter club ID or username" style="width: 100%; padding: 0.9rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Club Password</label>
                        <input type="password" class="form-input" id="clubPassword" placeholder="Enter club password" style="width: 100%; padding: 0.9rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                    </div>
                    
                    <button class="btn btn-primary btn-block" id="clubSigninBtn">
                        <i class="fas fa-sign-in-alt"></i> Sign In to Club Dashboard
                    </button>
                    
                    <p style="text-align: center; margin-top: 1.5rem; color: var(--gray); font-size: 0.9rem;">
                        Demo clubs: <br>
                        • "techclub" / "password123" <br>
                        • "artists" / "password123" <br>
                        • "sports" / "password123" <br>
                        • "science" / "password123"
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard (hidden by default) -->
    <div class="admin-container hidden" id="adminDashboard">
        <div class="admin-sidebar">
            <h2 class="mb-4">Admin Panel</h2>
            <div class="admin-nav">
                <div class="admin-nav-item active" data-admin-section="dashboard">Dashboard</div>
                <div class="admin-nav-item" data-admin-section="bulletins">Manage Bulletins</div>
                <div class="admin-nav-item" data-admin-section="stories">Manage Stories</div>
                <div class="admin-nav-item" data-admin-section="cardsets">Manage Card Sets</div>
                <div class="admin-nav-item" data-admin-section="cards">Manage Cards</div>
                <div class="admin-nav-item" data-admin-section="clubs">Manage Clubs</div>
                <div class="admin-nav-item" style="margin-top: 3rem;" id="logoutAdmin">Logout</div>
            </div>
        </div>
        
        <div class="admin-content">
            <div id="adminDashboardContent">
                <h1 class="mb-3">Admin Master Dashboard</h1>
                <p>Welcome to the admin panel. Use the sidebar to manage all content on the platform.</p>
                
                <div class="cards-container mt-4">
                    <div class="card">
                        <div class="card-header">Bulletins</div>
                        <div class="card-body">
                            <p>9 Bulletin Boards</p>
                            <p>Manage display types</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Stories</div>
                        <div class="card-body">
                            <p>24 Stories</p>
                            <p>CRUD operations</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Card Sets</div>
                        <div class="card-body">
                            <p>5 Card Sets</p>
                            <p>With 74 cards total</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Clubs</div>
                        <div class="card-body">
                            <p>46 Clubs</p>
                            <p>Each with dashboard</p>
                        </div>
                    </div>
                </div>
                
                <!-- Admin Content Sections -->
                <div id="adminManageBulletins" class="hidden mt-4">
                    <h3>Manage Bulletin Boards</h3>
                    <p>Edit, delete, or reorder the 8 bulletin boards.</p>
                </div>
                
                <div id="adminManageStories" class="hidden mt-4">
                    <h3>Manage Stories</h3>
                    <p>Add, edit, or delete stories across all bulletin boards.</p>
                </div>
                
                <div id="adminManageCardSets" class="hidden mt-4">
                    <h3>Manage Card Sets</h3>
                    <p>Organize cards into sets for different bulletin boards.</p>
                </div>
                <div class="footer-section">
                    <h4>Database</h4>
                    <ul class="footer-links">
                        <li><a href="database.html" target="_blank">JSON Database Manager</a></li>
                        <li><a href="#" onclick="exportData()">Export JSON</a></li>
                        <li><a href="#" onclick="importData()">Import JSON</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Club Dashboard (hidden by default) -->
    <div class="admin-container hidden" id="clubDashboard">
        <div class="admin-sidebar club-sidebar">
            <h2 class="mb-4" id="clubName">Club Dashboard</h2>
            <div class="admin-nav">
                <div class="admin-nav-item active" data-club-section="home">Club Home</div>
                <div class="admin-nav-item" data-club-section="members">Members</div>
                <div class="admin-nav-item" data-club-section="history">History</div>
                <div class="admin-nav-item" data-club-section="activities">Activities</div>
                <div class="admin-nav-item" data-club-section="settings">Settings</div>
                <div class="admin-nav-item" style="margin-top: 3rem;" id="logoutClub">Logout</div>
            </div>
        </div>
        
        <div class="admin-content">
            <!-- Club Home Content -->
            <div id="clubDashboardContent">
                <h1 class="mb-3" id="clubTitle">Club Dashboard</h1>
                <div class="club-header mb-4" style="height: 150px; background: linear-gradient(135deg, var(--success), #64dd17); border-radius: 10px; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column;">
                    <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <h2 id="clubHeaderName">Club Name</h2>
                    <p id="clubDescription" style="margin-top: 0.5rem; opacity: 0.9;"></p>
                </div>
                
                <!-- Club Stats -->
                <div class="club-stats mb-4">
                    <div class="stat-card">
                        <h4>TOTAL MEMBERS</h4>
                        <div class="stat-value" id="totalMembers">0</div>
                        <div class="stat-change positive" id="memberChange">+0 this month</div>
                    </div>
                    <div class="stat-card">
                        <h4>ACTIVE MEMBERS</h4>
                        <div class="stat-value" id="activeMembers">0</div>
                        <div class="stat-change positive" id="activeChange">+0 this week</div>
                    </div>
                    <div class="stat-card">
                        <h4>UPCOMING EVENTS</h4>
                        <div class="stat-value" id="upcomingEvents">0</div>
                        <div class="stat-change positive">Next: <span id="nextEventDate">Soon</span></div>
                    </div>
                    <div class="stat-card">
                        <h4>ACTIVITY LEVEL</h4>
                        <div class="stat-value" id="activityLevel">0%</div>
                        <div class="stat-change positive" id="activityChange">+0% from last month</div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <h3 class="mb-3">Recent Activity</h3>
                <div class="activity-list mb-4" id="recentActivity">
                    <!-- Activity items will be added dynamically -->
                </div>
                
                <!-- Upcoming Events -->
                <h3 class="mb-3">Upcoming Events</h3>
                <div class="cards-container">
                    <!-- Event cards will be added dynamically -->
                </div>
            </div>
            
            <!-- Members Section -->
            <div id="clubMembers" class="hidden mt-4">
                <div class="mb-4" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Club Members</h3>
                    <button class="btn btn-primary" id="addMemberBtn">
                        <i class="fas fa-user-plus"></i> Add Member
                    </button>
                </div>
                
                <!-- Member Filters -->
                <div class="year-nav mb-4">
                    <div class="year-btn active" data-filter="all">All Members</div>
                    <div class="year-btn" data-filter="active">Active</div>
                    <div class="year-btn" data-filter="inactive">Inactive</div>
                    <div class="year-btn" data-filter="leadership">Leadership</div>
                </div>
                
                <!-- Members Grid -->
                <div class="members-grid" id="membersGrid">
                    <!-- Member cards will be added dynamically -->
                </div>
            </div>
            
            <!-- History Section -->
            <div id="clubHistory" class="hidden mt-4">
                <h3 class="mb-4">Club History & Timeline</h3>
                <div class="event-timeline" id="clubTimeline">
                    <!-- Timeline events will be added dynamically -->
                </div>
            </div>
            
            <!-- Activities Section -->
            <div id="clubActivities" class="hidden mt-4">
                <div class="mb-4" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>Club Activities & Events</h3>
                    <button class="btn btn-primary" id="addActivityBtn">
                        <i class="fas fa-calendar-plus"></i> Add Activity
                    </button>
                </div>
                
                <!-- Activity Filters -->
                <div class="year-nav mb-4">
                    <div class="year-btn active" data-filter="upcoming">Upcoming</div>
                    <div class="year-btn" data-filter="past">Past Events</div>
                    <div class="year-btn" data-filter="all">All Activities</div>
                </div>
                
                <!-- Activities Grid -->
                <div class="cards-container" id="activitiesGrid">
                    <!-- Activity cards will be added dynamically -->
                </div>
            </div>
            
            <!-- Settings Section -->
            <div id="clubSettings" class="hidden mt-4">
                <h3 class="mb-4">Club Settings</h3>
                <div class="club-settings">
                    <form id="clubSettingsForm">
                        <div class="form-group">
                            <label class="form-label">Club Name</label>
                            <input type="text" class="form-control" id="settingsClubName" placeholder="Enter club name">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Club Description</label>
                            <textarea class="form-control" id="settingsClubDescription" rows="3" placeholder="Describe your club"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Contact Email</label>
                            <input type="email" class="form-control" id="settingsClubEmail" placeholder="club@example.com">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Club Website</label>
                            <input type="url" class="form-control" id="settingsClubWebsite" placeholder="https://example.com">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Meeting Schedule</label>
                            <input type="text" class="form-control" id="settingsMeetingSchedule" placeholder="e.g., Every Tuesday at 6 PM">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Change Password</label>
                            <input type="password" class="form-control" id="settingsNewPassword" placeholder="New password (leave blank to keep current)">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="settingsConfirmPassword" placeholder="Confirm new password">
                        </div>
                        
                        <button type="button" class="btn btn-primary" id="saveSettingsBtn">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<!-- Image Preview Modal -->
<div id="imagePreviewModal" class="modal hidden">
    <div class="modal-content" style="max-width: 90vw; max-height: 90vh; background: white; border-radius: 15px; padding: 20px; position: relative;">
        <button id="closeImagePreview" style="position: absolute; top: 15px; right: 15px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; cursor: pointer; z-index: 1001;">×</button>
        <div style="width: 100%; height: 100%; display: flex; flex-direction: column;">
            <div id="previewImageContainer" style="flex: 1; overflow: auto; display: flex; justify-content: center; align-items: center; padding: 20px;">
                <img id="previewImage" src="" alt="Preview" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 10px;">
            </div>
            <div id="previewImageInfo" style="padding: 20px; border-top: 1px solid #eee; background: #f8f9fa; border-radius: 0 0 10px 10px;">
                <h3 id="previewImageTitle" style="margin: 0 0 10px 0; color: var(--primary);"></h3>
                <p id="previewImageDescription" style="margin: 0; color: #666; font-size: 0.9rem;"></p>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div id="detailsModal" class="modal hidden">
    <div class="modal-content" style="max-width: 800px; max-height: 85vh; background: white; border-radius: 15px; padding: 0; position: relative;">
        <button id="closeDetailsModal" style="position: absolute; top: 15px; right: 15px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; cursor: pointer; z-index: 1001;">×</button>
        
        <div style="width: 100%; height: 100%; display: flex; flex-direction: column;">
            <!-- Image Section -->
            <div id="modalImageSection" class="hidden" style="flex: 2; min-height: 300px; background: #f8f9fa; display: flex; justify-content: center; align-items: center; padding: 20px;">
                <img id="modalImage" src="" alt="Detail Image" style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 10px;">
            </div>
            
            <!-- Content Section -->
            <div id="modalContentSection" style="flex: 1; overflow-y: auto; padding: 2rem;">
                <h2 id="modalItemTitle" style="margin: 0 0 1rem 0; color: var(--primary);"></h2>
                
                <!-- Subtitle -->
                <div id="modalItemSubtitle" style="font-size: 1.1rem; color: var(--secondary); margin-bottom: 1.5rem;"></div>
                
                <!-- Details -->
                <div id="modalItemDetails" style="margin-bottom: 1.5rem;"></div>
                
                <!-- Specific sections -->
                <div id="modalYearDetails" class="hidden" style="margin-top: 1.5rem;"></div>
                <div id="modalDonationDetails" class="hidden" style="margin-top: 1.5rem;"></div>
                <div id="modalEventDetails" class="hidden" style="margin-top: 1.5rem;"></div>
                
                <!-- Pictures Gallery -->
                <div id="modalEventPictures" class="hidden" style="margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">Event Pictures</h4>
                    <div class="picture-gallery" id="modalEventPicturesGallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Database Loading Function - Reads from localStorage
    function loadPlatformData() {
        const saved = localStorage.getItem('centerNecklaceDatabase');
        if (saved) {
            try {
                return JSON.parse(saved);
            } catch (e) {
                console.error('Error loading database:', e);
                return getDefaultData();
            }
        } else {
            return getDefaultData();
        }
    }

    // Update the getDefaultData function in index.html
    function getDefaultData() {
        return {
        bulletins: [
            { id: 1, title: "Our Mission", type: "scrolling", storyId: 1, yearsSetId: 1 },
            { id: 2, title: "Our Timelines", type: "years", yearsSetId: 1 },
            { id: 3, title: "Our History", type: "years", yearsSetId: 1 },
            { id: 4, title: "Our Members", type: "mixed", storyId: 2, cardSetId: [1,2] },
            { id: 5, title: "Our Clubs", type: "cards", cardSetId: 2, count: 46 },
            { id: 6, title: "Our Branches", type: "cards", cardSetId: 3, count: 7 },
            { id: 7, title: "Letter Collection (21 Cards)", type: "cards", cardSetId: 4, count: 21 },
            { id: 8, title: "Partners", type: "clubs", clubSetIds: [1], clubsPerRow: 3, showJoinButton: true },
            { id: 9, title: "Contact", type: "contact" }
        ],
            stories: [
                { id: 1, title: "Compact Horizontal Necklace Navigation", content: `This navigation places the active bulletin in the center with the other bulletins arranged horizontally around it like pearls on a necklace.
                
                and to show spaces and style...` 
                },
                { id: 2, title: "Featured Content Hub", content: `This bulletin demonstrates the mixed content capability of the platform.
                
                and to show space and style...`},
                { id: 3, title: "2023 Annual Report", content: `2023 has been a transformative year for our organization.

                and to show space and style...`},
                { id: 4, title: "2022 Highlights & Achievements", content: `In 2022, we focused on digital transformation and community outreach.

                and to show space and style...`}
            ],
            cardSets: [
                { 
                    id: 1, 
                    name: "Featured Cards", 
                    subtitle: "Meet our key members",
                    cards: [
                        { 
                            id: 1, 
                            name: "John Smith", 
                            title: "CEO & Founder", 
                            introduction: "With over 15 years of experience in community leadership, John founded our organization to make a lasting impact.",
                            picture: "pic_2023_gala_1"  // Using picture ID instead of path
                        },
                        { 
                            id: 2, 
                            name: "Maria Garcia", 
                            title: "Program Director", 
                            introduction: "Maria manages our outreach programs and ensures every initiative aligns with our mission.",
                            picture: "pic_2023_gala_2"  // Using picture ID instead of path
                        },
                        { 
                            id: 3, 
                            name: "David Chen", 
                            title: "Operations Manager",
                            picture: "pic_2023_festival_1"  // Using picture ID instead of path
                            // No introduction provided for this card
                        }
                    ] 
                },
                { 
                    id: 2, 
                    name: "All Clubs", 
                    subtitle: "46 active clubs in our community",
                    cards: Array.from({length: 46}, (_, i) => ({
                        id: i + 4,
                        name: `Club Member ${i + 1}`,
                        title: `Club Representative`,
                        introduction: `Active participant in community clubs and initiatives.`,
                        picture: `./picture/member_${i + 1}.jpg`  // Use direct path instead of ID
                    }))
                },
                { 
                    id: 3, 
                    name: "External Links", 
                    cards: Array.from({length: 7}, (_, i) => ({
                        id: i + 50,
                        name: `External Link ${i + 1}`,
                        title: `External Resource`,
                        introduction: `Useful external resource for our community.`,
                        picture: `./picture/external_${i + 1}.jpg`
                    }))
                },
                { 
                    id: 4, 
                    name: "Letter Collection", 
                    cards: Array.from({length: 21}, (_, i) => ({
                        id: i + 57,
                        name: `Letter ${String.fromCharCode(65 + i)}`,
                        title: `Educational Resource`,
                        introduction: `Educational material for learning.`,
                        picture: `./picture/letter_${String.fromCharCode(65 + i)}.jpg`
                    }))
                }
            ],
            clubs: [
                {
                    id: "techclub",
                    name: "Technology Club",
                    password: "password123",
                    description: "A club for technology enthusiasts interested in coding, hardware, and innovation.",
                    founded: "2018",
                    totalMembers: 156,
                    activeMembers: 142,
                    upcomingEvents: 3,
                    activityLevel: "85%",
                    contactEmail: "techclub@example.com",
                    website: "https://techclub.example.com",
                    meetingSchedule: "Every Wednesday at 7 PM",
                    members: [
                        { id: 1, name: "Alex Johnson", role: "President", status: "active", joinDate: "2022-03-15" },
                        { id: 2, name: "Maria Garcia", role: "Vice President", status: "active", joinDate: "2021-11-22" },
                        { id: 3, name: "David Chen", role: "Treasurer", status: "active", joinDate: "2023-01-10" },
                        { id: 4, name: "Sarah Williams", role: "Secretary", status: "active", joinDate: "2022-08-05" }
                    ]
                }
            ],
            yearsSets: [
                {
                    id: 1,
                    name: "Recent 5 Years",
                    years: [
                        { 
                            year: 2023, 
                            donations: [
                                { id: 1, amount: 10000, notes: "Major donor: John Smith" },
                                { id: 2, amount: 15000, notes: "Corporate sponsorship" },
                                { id: 3, amount: 25000, notes: "Community fundraiser" }
                            ], 
                            events: [
                                { 
                                    id: 1, 
                                    name: "Annual Gala", 
                                    date: "2023-05-15", 
                                    description: "Annual fundraising gala event",
                                    attendees: 250,
                                    location: "Grand Hotel",
                                    pictures: ["pic_2023_gala_1", "pic_2023_gala_2"]  // Picture IDs
                                },
                                { 
                                    id: 2, 
                                    name: "Summer Festival", 
                                    date: "2023-07-22", 
                                    description: "Community summer festival",
                                    attendees: 500,
                                    location: "City Park",
                                    pictures: ["pic_2023_festival_1"]  // Picture ID
                                }
                            ] 
                        },
                        { 
                            year: 2022, 
                            donations: [
                                { id: 1, amount: 8000, notes: "Foundation grant" },
                                { id: 2, amount: 12000, notes: "Individual donations" }
                            ], 
                            events: [
                                { 
                                    id: 1, 
                                    name: "Winter Charity Ball", 
                                    date: "2022-12-10", 
                                    description: "Charity ball for winter fundraising",
                                    attendees: 180,
                                    location: "Royal Hall",
                                    pictures: ["pic_2022_ball_1"]  // Picture ID
                                }
                            ] 
                        }
                    ]
                }
            ],
            pictureFolder: {
                "pic_2023_gala_1": {
                    id: "pic_2023_gala_1",
                    fileName: "gala_2023_1.jpg",
                    originalName: "gala_2023_1.jpg",
                    size: 102400,
                    type: "image/jpeg",
                    uploaded: "2023-05-16T10:30:00Z",
                    path: "./picture/gala_2023_1.jpg"
                },
                "pic_2023_gala_2": {
                    id: "pic_2023_gala_2",
                    fileName: "gala_2023_2.jpg",
                    originalName: "gala_2023_2.jpg",
                    size: 98304,
                    type: "image/jpeg",
                    uploaded: "2023-05-16T10:35:00Z",
                    path: "./picture/gala_2023_2.jpg"
                },
                "pic_2023_festival_1": {
                    id: "pic_2023_festival_1",
                    fileName: "festival_2023_1.jpg",
                    originalName: "festival_2023_1.jpg",
                    size: 153600,
                    type: "image/jpeg",
                    uploaded: "2023-07-23T14:20:00Z",
                    path: "./picture/festival_2023_1.jpg"
                },
                "pic_2022_ball_1": {
                    id: "pic_2022_ball_1",
                    fileName: "ball_2022_1.jpg",
                    originalName: "ball_2022_1.jpg",
                    size: 89600,
                    type: "image/jpeg",
                    uploaded: "2022-12-11T09:15:00Z",
                    path: "./picture/ball_2022_1.jpg"
                }
            },
                    clubSets: [
            {
                id: 1,
                name: "Partner Organizations",
                subtitle: "Our valued partners and collaborators",
                displayAsCards: true,
                clubs: [
                    {
                        id: 1,
                        name: "Technology Club",
                        description: "A club for technology enthusiasts interested in coding, hardware, and innovation.",
                        link: "https://techclub.example.com",
                        icon: "fas fa-laptop-code"
                    },
                    {
                        id: 2,
                        name: "Science Society",
                        description: "Promoting scientific research and education in the community.",
                        link: "https://science.example.com/login",
                        icon: "fas fa-flask"
                    },
                    {
                        id: 3,
                        name: "Arts Alliance",
                        description: "Supporting local artists and cultural events.",
                        link: "https://arts.example.com/member-portal",
                        icon: "fas fa-palette"
                    }
                ]
            }
        ],
        
        clubs: [], // Empty this since we're using clubSets now
        };
        showNotification('Using default database', 'info');
    }

    // Load data from shared database
    let platformData = loadPlatformData();
    
    // Update total bulletins based on loaded data
    let totalBulletins = platformData.bulletins.length;
    
    // Compact Horizontal Necklace Navigation Setup
    const necklaceTrack = document.getElementById('necklaceTrack');
    let activeBulletin = 1;
    let visiblePearls = 5; // Number of pearls visible at once
    let autoRotateInterval;
    
    // Mobile menu elements
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    
    // Dashboard elements
    const signinModal = document.getElementById('signinModal');
    const signinBtn = document.getElementById('signinBtn');
    const adminDashboard = document.getElementById('adminDashboard');
    const clubDashboard = document.getElementById('clubDashboard');
    
    // Current club data
    let currentClub = null;

    // Initialize necklace with compact horizontal layout
    function initializeNecklace() {
        // Clear existing pearls
        necklaceTrack.innerHTML = '';
        
        // Sort bulletins by ID
        sortBulletins();

        // Update total bulletins count
        totalBulletins = platformData.bulletins.length;
        
        // Create pearls based on actual bulletins in database
        for (let i = 0; i < totalBulletins; i++) {
            const bulletin = platformData.bulletins[i];
            const isActive = bulletin.id === activeBulletin;
            const pearl = document.createElement('div');
            pearl.className = isActive ? 'center-pearl' : 'outer-pearl';
            pearl.dataset.bulletin = bulletin.id;
            pearl.innerHTML = `
                <div class="${isActive ? 'center-number' : 'pearl-number'}">${bulletin.id}</div>
                <div class="${isActive ? 'center-label' : 'pearl-label'}">${getShortTitle(bulletin.title)}</div>
            `;
            
            // Add click event
            pearl.addEventListener('click', () => {
                selectBulletin(bulletin.id);
            });
            
            necklaceTrack.appendChild(pearl);
        }
        
        // Position pearls to show active in center
        positionPearls();
        
        // Update current bulletin indicator
        updateCurrentBulletin();
        
        // Update navigation items
        updateNavigationItems();
    }
    
    // Helper function to get short title for pearls
    function getShortTitle(title) {
        if (title.length <= 10) return title;
        return title.split(' ')[0] + '...';
    }
    
    // Update navigation items based on database
    function updateNavigationItems() {
        // Sort bulletins by ID
        sortBulletins();

        // Update header nav items
        const headerNav = document.getElementById('headerNav');
        headerNav.innerHTML = '';
        
        platformData.bulletins.forEach(bulletin => {
            const navItem = document.createElement('div');
            navItem.className = 'header-nav-item';
            navItem.classList.toggle('active', bulletin.id === activeBulletin);
            navItem.dataset.bulletin = bulletin.id;
            navItem.textContent = `${bulletin.title}`;
            navItem.title = bulletin.title;
            
            navItem.addEventListener('click', () => {
                selectBulletin(bulletin.id);
            });
            
            headerNav.appendChild(navItem);
        });
        
        // Update side menu items
        // Update side menu items text
        const sideMenuItems = document.querySelector('.side-menu-items');
        sideMenuItems.innerHTML = '';

        platformData.bulletins.forEach(bulletin => {
            let displayText = '';
            switch(bulletin.id) {
                case 1:
                    displayText = `Our Mission`;
                    break;
                case 2:
                    displayText = `Our Timelines`;
                    break;
                case 3:
                    displayText = `Our History`;
                    break;
                default:
                    displayText = `${bulletin.title.substring(0, 20)}${bulletin.title.length > 20 ? '...' : ''}`;
            }
            
            const menuItem = document.createElement('div');
            menuItem.className = 'side-menu-item';
            menuItem.classList.toggle('active', bulletin.id === activeBulletin);
            menuItem.dataset.bulletin = bulletin.id;
            menuItem.innerHTML = `<span>${displayText}</span>`;
            
            menuItem.addEventListener('click', () => {
                selectBulletin(bulletin.id);
                sideMenu.classList.remove('active');
                menuOverlay.classList.remove('active');
            });
            
            sideMenuItems.appendChild(menuItem);
        });
        
        // Update footer links
        updateFooterLinks();
    }
    
    // Update footer links
    function updateFooterLinks() {
        // Update Navigation section
        const navLinks = document.querySelector('.footer-section:nth-child(1) .footer-links');
        navLinks.innerHTML = '';
        
        platformData.bulletins.slice(0, 4).forEach(bulletin => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#';
            a.dataset.bulletin = bulletin.id;
            a.textContent = `Bulletin ${bulletin.id} - ${bulletin.title.substring(0, 20)}...`;
            a.addEventListener('click', (e) => {
                e.preventDefault();
                selectBulletin(bulletin.id);
            });
            li.appendChild(a);
            navLinks.appendChild(li);
        });
        
        // Update Card Collections section
        const cardLinks = document.querySelector('.footer-section:nth-child(2) .footer-links');
        cardLinks.innerHTML = '';
        
        platformData.bulletins.slice(4, 8).forEach(bulletin => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#';
            a.dataset.bulletin = bulletin.id;
            a.textContent = `Bulletin ${bulletin.id} - ${bulletin.title.substring(0, 20)}...`;
            a.addEventListener('click', (e) => {
                e.preventDefault();
                selectBulletin(bulletin.id);
            });
            li.appendChild(a);
            cardLinks.appendChild(li);
        });
    }
    
    // Position pearls to show active in center
    function positionPearls() {
        const pearls = necklaceTrack.querySelectorAll('.center-pearl, .outer-pearl');
        const activeIndex = platformData.bulletins.findIndex(b => b.id === activeBulletin);
        
        if (activeIndex === -1 && platformData.bulletins.length > 0) {
            activeBulletin = platformData.bulletins[0].id;
            initializeNecklace();
            return;
        }
        
        // Calculate which pearls should be visible
        const halfVisible = Math.floor(visiblePearls / 2);
        let startIndex = activeIndex - halfVisible;
        let endIndex = activeIndex + halfVisible;
        
        // Adjust for boundaries
        if (startIndex < 0) {
            endIndex += Math.abs(startIndex);
            startIndex = 0;
        }
        if (endIndex >= totalBulletins) {
            startIndex -= (endIndex - totalBulletins + 1);
            endIndex = totalBulletins - 1;
        }
        
        // Reset all pearls first
        pearls.forEach((pearl, index) => {
            pearl.style.display = 'flex';
            pearl.style.opacity = '0.7';
            pearl.style.transform = 'scale(0.8)';
            
            // Hide pearls outside visible range
            if (index < startIndex || index > endIndex) {
                pearl.style.display = 'none';
            }
        });
        
        // Style visible pearls based on position relative to center
        for (let i = startIndex; i <= endIndex; i++) {
            const pearl = pearls[i];
            const distanceFromCenter = Math.abs(i - activeIndex);
            const scale = 1 - (distanceFromCenter * 0.2);
            const opacity = 1 - (distanceFromCenter * 0.3);
            
            if (i === activeIndex) {
                pearl.className = 'center-pearl';
                pearl.style.opacity = '1';
                pearl.style.transform = 'scale(1)';
            } else {
                pearl.className = 'outer-pearl';
                pearl.style.opacity = opacity.toString();
                pearl.style.transform = `scale(${scale})`;
            }
        }
    }
    
    // Update current bulletin indicator
    function updateCurrentBulletin() {
        document.getElementById('currentBulletin').textContent = activeBulletin;
    }
    
    // Select bulletin function
    function selectBulletin(id) {
        //stopAutoRotation();
        // Check if bulletin exists
        const bulletinExists = platformData.bulletins.some(b => b.id === id);
        if (!bulletinExists) {
            console.warn(`Bulletin ${id} not found, defaulting to first bulletin`);
            if (platformData.bulletins.length > 0) {
                activeBulletin = platformData.bulletins[0].id;
            } else {
                console.error('No bulletins available in database');
                return;
            }
        } else {
            activeBulletin = id;
        }
        
        // Stop auto-rotation when a bulletin is manually selected
        clearInterval(autoRotateInterval);
        
        // Update navigation states
        updateNavigationStates();
        
        // Update necklace display
        initializeNecklace();
        
        // Update content display
        updateDisplay(activeBulletin);
        
        // Show notification that rotation is paused
        showNotification('Auto-rotation paused. Click "Resume Rotation" to resume.', 'info');
        
        // Add resume button if not already present
        addResumeRotationButton();
    }

    function addResumeRotationButton() {
        // Find the navigation container
        const navContainer = document.querySelector('.nav-controls') || 
                            document.querySelector('.header-actions') || 
                            document.querySelector('.header-nav');
        
        if (!navContainer) {
            console.error('Navigation container not found');
            return;
        }
        
        // Check if button already exists
        if (document.getElementById('resumeRotationBtn')) {
            return;
        }
        
        // Create the resume rotation button
        const resumeButton = document.createElement('button');
        resumeButton.id = 'resumeRotationBtn';
        resumeButton.className = 'btn btn-warning';
        resumeButton.style.marginLeft = '10px';
        resumeButton.innerHTML = '<i class="fas fa-play"></i> Resume Rotation';
        resumeButton.onclick = function() {
            resumeAutoRotation();
            this.style.display = 'none';
        };
        
        // Try to find a good place to insert the button
        // Look for an existing element to insert before
        const firstChild = navContainer.firstChild;
        
        if (firstChild) {
            // Insert before the first child
            navContainer.insertBefore(resumeButton, firstChild);
        } else {
            // Just append if no children
            navContainer.appendChild(resumeButton);
        }
    }

    // Update all navigation states (header, side menu)
    function updateNavigationStates() {
        // Update header nav items
        document.querySelectorAll('.header-nav-item').forEach(item => {
            if (parseInt(item.dataset.bulletin) === activeBulletin) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
        
        // Update side menu items
        document.querySelectorAll('.side-menu-item').forEach(item => {
            if (parseInt(item.dataset.bulletin) === activeBulletin) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    }
    
    // Navigation controls
    document.getElementById('prevBtn').addEventListener('click', () => {
        const currentIndex = platformData.bulletins.findIndex(b => b.id === activeBulletin);
        let newIndex = currentIndex - 1;
        if (newIndex < 0) newIndex = platformData.bulletins.length - 1;
        selectBulletin(platformData.bulletins[newIndex].id);
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
        const currentIndex = platformData.bulletins.findIndex(b => b.id === activeBulletin);
        let newIndex = currentIndex + 1;
        if (newIndex >= platformData.bulletins.length) newIndex = 0;
        selectBulletin(platformData.bulletins[newIndex].id);
    });

    // Mobile menu functionality
    mobileMenuBtn.addEventListener('click', () => {
        sideMenu.classList.add('active');
        menuOverlay.classList.add('active');
    });
    
    menuOverlay.addEventListener('click', () => {
        sideMenu.classList.remove('active');
        menuOverlay.classList.remove('active');
    });
    
    // Auto-rotate function
    function startAutoRotate() {
        // Clear any existing interval
        clearInterval(autoRotateInterval);
        
        autoRotateInterval = setInterval(() => {
            const currentIndex = platformData.bulletins.findIndex(b => b.id === activeBulletin);
            let newIndex = currentIndex + 1;
            if (newIndex >= platformData.bulletins.length) newIndex = 0;
            selectBulletin(platformData.bulletins[newIndex].id);
        }, 15000);
        
        // Remove resume button if it exists
        const resumeBtn = document.querySelector('.resume-rotation-btn');
        if (resumeBtn) {
            resumeBtn.remove();
        }
    }

    // Helper function to get picture from folder by ID
    function getPictureFromFolder(pictureId) {
        if (!platformData.pictureFolder || !platformData.pictureFolder[pictureId]) {
            console.warn(`Picture not found: ${pictureId}`);
            return null;
        }
        return platformData.pictureFolder[pictureId];
    }

    // Function to preview picture by ID
    function previewPicture(pictureId) {
        const picture = getPictureFromFolder(pictureId);
        if (!picture) {
            alert(`Picture not found: ${pictureId}`);
            return;
        }
        
        const imgSrc = picture.path || `./picture/${picture.fileName}`;
        
        const modalContent = `
            <div style="text-align: center;">
                <img src="${imgSrc}" 
                    alt="${picture.originalName || picture.fileName}"
                    style="max-width: 100%; max-height: 70vh; border-radius: 5px;"
                    onerror="this.src='https://via.placeholder.com/600x400?text=Picture+Not+Found'">
                <div style="margin-top: 1rem; text-align: left;">
                    <p><strong>Picture ID:</strong> ${picture.id}</p>
                    <p><strong>File Name:</strong> ${picture.fileName}</p>
                    ${picture.originalName ? `<p><strong>Original Name:</strong> ${picture.originalName}</p>` : ''}
                    <p><strong>Path:</strong> ${picture.path || `./picture/${picture.fileName}`}</p>
                    <p><strong>Size:</strong> ${picture.size ? ((picture.size / 1024).toFixed(2) + ' KB') : 'Unknown'}</p>
                    <p><strong>Uploaded:</strong> ${picture.uploaded ? new Date(picture.uploaded).toLocaleString() : 'Unknown'}</p>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn" onclick="closePicturePreview()" style="padding: 0.8rem 1.5rem;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        `;
        
        const modal = document.createElement('div');
        modal.id = 'picturePreviewModal';
        modal.className = 'modal active';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                ${modalContent}
            </div>
        `;
        document.body.appendChild(modal);
    }

    // Close picture preview when clicking outside
    document.addEventListener('click', (e) => {
        const modal = document.getElementById('picturePreviewModal');
        if (modal && e.target === modal) {
            modal.remove();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const modal = document.getElementById('picturePreviewModal');
            if (modal) {
                modal.remove();
            }
        }
    });

    // Update display based on selected bulletin
    // Update display based on selected bulletin
function updateDisplay(bulletinId) {
    const bulletin = platformData.bulletins.find(b => b.id === bulletinId);
    
    if (!bulletin) {
        document.getElementById('displayTitle').textContent = 'Bulletin Not Found';
        document.getElementById('displayContent').innerHTML = `
            <div class="text-center" style="padding: 4rem;">
                <h3>Bulletin Not Found</h3>
                <p>The requested bulletin does not exist in the database.</p>
                <button class="btn btn-primary" onclick="selectBulletin(1)">Go to First Bulletin</button>
            </div>
        `;
        return;
    }
    
    const displayTitle = document.getElementById('displayTitle');
    const displayContent = document.getElementById('displayContent');
    
    displayTitle.textContent = bulletin.title;
    displayContent.innerHTML='';
    
    switch(bulletin.type) {
        case 'scrolling':
            // Get the story
            const story = platformData.stories.find(s => s.id === bulletin.storyId);
            
            // Calculate total donation from yearsSet
            let totalDonation = 0;
            if (bulletin.yearsSetId) {
                const yearsSet = platformData.yearsSets.find(ys => ys.id === bulletin.yearsSetId);
                if (yearsSet) {
                    yearsSet.years.forEach(year => {
                        if (year.donations) {
                            year.donations.forEach(donation => {
                                totalDonation += donation.amount || 0;
                            });
                        }
                    });
                }
            }
            
            if (story) {
                // Split the content by new lines and create paragraphs
                const storyParagraphs = story.content.split('\n').filter(p => p.trim());
                const storyContentHTML = storyParagraphs.map(p => `<p style="margin-bottom: 1rem;">${p}</p>`).join('');
                
                displayContent.innerHTML = `
                    <div class="bulletin-1">
                        <div class="scrolling-bg"></div>
                        <div class="story-display">
                            <h3 class="mb-2">${story.title}</h3>
                            <div style="line-height: 1.6;">
                                ${storyContentHTML}
                            </div>
                        </div>
                        <div class="number-display" style="padding: 1.5rem; text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">OUR IMPACT</div>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;">
                                We believe that giving is more valuable than receiving.
                            </div>
                            
                            <div style="margin: 1rem 0;">
                                <div style="font-size: 1.8rem; font-weight: 800; color: var(--success);">$${totalDonation.toLocaleString()}+</div>
                                <div style="font-size: 0.8rem; color: #666;">Total Donations</div>
                            </div>
                            
                            <div style="margin: 1rem 0;">
                                <div style="font-size: 1.5rem; font-weight: 800; color: var(--accent);">37,000</div>
                                <div style="font-size: 0.8rem; color: #666;">Lives Touched</div>
                            </div>
                            
                            <div style="margin: 1rem 0;">
                                <div style="font-size: 1.5rem; font-weight: 800; color: var(--warning);">60,500</div>
                                <div style="font-size: 0.8rem; color: #666;">Items Sent</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                displayContent.innerHTML = `
                    <div class="bulletin-1">
                        <div class="scrolling-bg"></div>
                        <div class="story-display">
                            <h3 class="mb-2">${bulletin.title}</h3>
                            <p>Story not found. Please check the database configuration.</p>
                        </div>
                        <div class="number-display">
                            <div>$${totalDonation.toLocaleString()}</div>
                            <div class="number-label">Total Donations</div>
                        </div>
                    </div>
                `;
            }
            break;
                    
        case 'years':
            const yearsSetId = bulletin.yearsSetId;
            if (yearsSetId) {
                const yearsSet = platformData.yearsSets.find(ys => ys.id === yearsSetId);
                if (yearsSet && yearsSet.years && yearsSet.years.length > 0) {
                    // Determine if this is bulletin 2 (donations only) or bulletin 3 (events only)
                    const isBulletin2 = bulletin.id === 2;
                    const isBulletin3 = bulletin.id === 3;
                    
                    displayContent.innerHTML = `
                        <h3 class="mb-3">${bulletin.title}</h3>
                        <p class="mb-3">${isBulletin2 ? 'Select a year to view donation details' : 'Select a year to view event details'}</p>
                        <div class="year-nav" id="yearNav"></div>
                        <div id="yearContent">
                            <div class="story-container" id="yearDetails">
                                <p>Select a year above to view details.</p>
                            </div>
                        </div>
                    `;
                    
                    const yearNav = document.getElementById('yearNav');
                    const yearDetails = document.getElementById('yearDetails');
                    
                    // Create year buttons
                    yearsSet.years.forEach((yearData, index) => {
                        const yearBtn = document.createElement('div');
                        yearBtn.className = index === 0 ? 'year-btn active' : 'year-btn';
                        yearBtn.textContent = yearData.year;
                        yearBtn.dataset.year = yearData.year;
                        
                        yearBtn.addEventListener('click', () => {
                            document.querySelectorAll('.year-btn').forEach(btn => btn.classList.remove('active'));
                            yearBtn.classList.add('active');
                            
                            // Show details for selected year based on bulletin type
                            if (isBulletin2) {
                                // BULLETIN 2: Show donations only
                                showDonationsOnly(yearData, yearDetails);
                            } else if (isBulletin3) {
                                // BULLETIN 3: Show events only
                                showEventsOnly(yearData, yearDetails);
                            } else {
                                // Default: Show both
                                showYearDetails(yearData, yearDetails);
                            }
                        });
                        
                        yearNav.appendChild(yearBtn);
                    });
                    
                    // Trigger click on first year
                    if (yearNav.querySelector('.year-btn')) {
                        yearNav.querySelector('.year-btn').click();
                    }
                } else {
                    displayContent.innerHTML = `
                        <div class="text-center" style="padding: 4rem;">
                            <h3>No Years Data Available</h3>
                            <p>Please select a Years Set in the database for this bulletin.</p>
                            <p>Go to <a href="database.html" target="_blank" style="color: var(--primary); text-decoration: underline;">Database Manager</a> to add years sets and events.</p>
                        </div>
                    `;
                }
            } else {
                displayContent.innerHTML = `
                    <div class="text-center" style="padding: 4rem;">
                        <h3>Years Set Not Configured</h3>
                        <p>This bulletin needs a Years Set ID configured.</p>
                        <p>Go to <a href="database.html" target="_blank" style="color: var(--primary); text-decoration: underline;">Database Manager</a> to configure this bulletin.</p>
                    </div>
                `;
            }
            break;

        case 'mixed':
            // BULLETIN 4: Mixed Content with multiple card sets
            const mixedStory = platformData.stories.find(s => s.id === bulletin.storyId);
            
            // Get all selected card sets - FIXED: Handle both cardSetId (array) and cardSetIds
            const mixedCardSetIds = bulletin.cardSetIds || (bulletin.cardSetId ? 
                (Array.isArray(bulletin.cardSetId) ? bulletin.cardSetId : [bulletin.cardSetId]) : []);
            
            const mixedCardSets = mixedCardSetIds
                .map(id => platformData.cardSets.find(cs => cs.id === id))
                .filter(cs => cs); // Remove undefined
            
            // Format story content with proper paragraphs
            let storyContentHTML = '';
            if (mixedStory && mixedStory.content) {
                const storyParagraphs = mixedStory.content.split('\n').filter(p => p.trim());
                storyContentHTML = storyParagraphs.map(p => `<p style="margin-bottom: 1rem; font-size: 1.1rem; line-height: 1.6;">${p}</p>`).join('');
            }
            
            // Create tab HTML for card sets
            let cardSetTabsHTML = '';
            if (mixedCardSets.length > 0) {
                cardSetTabsHTML = `
                    <div class="year-nav mb-4" id="cardSetTabs">
                        <div class="year-btn active" data-content="story">Founding Story</div>
                        ${mixedCardSets.map((cardSet, index) => `
                            <div class="year-btn" data-content="cardset-${index}" data-set-index="${index}">
                                ${cardSet.name}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                cardSetTabsHTML = `
                    <div class="year-nav mb-4">
                        <div class="year-btn active" data-content="story">Founding Story</div>
                    </div>
                `;
            }
            
            // Create content for each card set
            let cardSetContentsHTML = '';
            if (mixedCardSets.length > 0) {
                cardSetContentsHTML = mixedCardSets.map((cardSet, index) => {
                    const cards = cardSet.cards || [];
                    return `
                        <div class="cards-container ${index === 0 ? '' : 'hidden'}" id="cardset-${index}">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
                                ${cards.length > 0 ? 
                                    cards.map(card => {
                                        // Use larger picture (120px) for bulletin 4
                                        const pictureHtml = getCardPictureHTML(card, 120);
                                        // Escape for HTML attributes
                                        const safeName = escapeHtml(card.name);
                                        const safeTitle = card.title ? escapeHtml(card.title) : '';
                                        const safeIntroduction = card.introduction ? escapeHtml(card.introduction) : '';
                                        const pictureUrl = getCardPictureUrl(card);
                                        
                                       return `
                                            <div class="card clickable" style="..." 
                                                data-card='${JSON.stringify(card).replace(/'/g, "&#39;")}'>
                                                ${pictureHtml}
                                                <div style="margin-top: 1rem; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; width: 100%;">
                                                    <div>
                                                        <h4 style="margin: 0.5rem 0; color: var(--primary); font-size: 1.1rem;">${card.name}</h4>
                                                        ${card.title ? `<p style="font-weight: 600; color: var(--secondary); margin-bottom: 0.5rem; font-size: 0.95rem;">${card.title}</p>` : ''}
                                                        ${card.introduction ? `<p style="color: #555; font-size: 0.9rem; line-height: 1.4; margin-top: 0.8rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">${card.introduction}</p>` : ''}
                                                        ${!card.title && !card.introduction ? '<p style="color: #888; font-style: italic; margin-top: 0.8rem;">Member of our community.</p>' : ''}
                                                    </div>
                                                    <div style="margin-top: 1rem; color: var(--primary); font-size: 0.8rem;">
                                                        <i class="fas fa-eye"></i> Click to view details
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('') : 
                                    `<p style="text-align: center; padding: 2rem; color: #666; grid-column: 1 / -1;">No cards in this set.</p>`
                                }
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                cardSetContentsHTML = `
                    <div class="cards-container hidden" id="cardset-0">
                        <p style="text-align: center; padding: 2rem; color: #666;">No card sets configured for this bulletin.</p>
                    </div>
                `;
            }
            
            displayContent.innerHTML = `
                <div style="max-width: 100%;">
                    <h2 class="mb-3" style="color: var(--primary); font-size: 1.8rem;">${bulletin.title}</h2>
                    ${mixedCardSets.length > 0 ? 
                        `<p class="mb-4" style="font-size: 1.1rem; color: var(--secondary);">Showing content from ${mixedCardSets.length} card set${mixedCardSets.length > 1 ? 's' : ''}.</p>` : 
                        ''
                    }
                    
                    ${cardSetTabsHTML}
                    
                    <div id="mixedContent" style="width: 100%;">
                        <div class="story-container" id="mixedStory" style="width: 100%;">
                            <h3 class="mb-4" style="color: var(--primary); font-size: 1.5rem;">${mixedStory ? mixedStory.title : 'Story Not Found'}</h3>
                            <div style="line-height: 1.6; font-size: 1.05rem; background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%;">
                                ${storyContentHTML || '<p>No story content available.</p>'}
                            </div>
                        </div>
                        ${cardSetContentsHTML}
                    </div>
                </div>
            `;
            
            // Add event listeners for switching between story and card sets
            setTimeout(() => {
                document.querySelectorAll('#displayContent .year-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Update button states
                        document.querySelectorAll('#displayContent .year-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        const contentId = btn.dataset.content;
                        
                        // Hide all content
                        document.getElementById('mixedStory').classList.add('hidden');
                        mixedCardSets.forEach((_, index) => {
                            const cardsetDiv = document.getElementById(`cardset-${index}`);
                            if (cardsetDiv) cardsetDiv.classList.add('hidden');
                        });
                        
                        // Show selected content
                        if (contentId === 'story') {
                            document.getElementById('mixedStory').classList.remove('hidden');
                        } else if (contentId.startsWith('cardset-')) {
                            const setIndex = parseInt(contentId.split('-')[1]);
                            const cardsetDiv = document.getElementById(`cardset-${setIndex}`);
                            if (cardsetDiv) cardsetDiv.classList.remove('hidden');
                        }
                    });
                });
            }, 0);

            break;
            
        case 'cards':
            // FIX: Handle both single cardSetId and array cardSetIds
            let cardSetIds = [];
            
            if (bulletin.cardSetIds && Array.isArray(bulletin.cardSetIds)) {
                // Multiple card sets
                cardSetIds = bulletin.cardSetIds;
            } else if (bulletin.cardSetId) {
                // Single card set (backward compatibility)
                cardSetIds = [bulletin.cardSetId];
            }
            
            if (cardSetIds.length === 0) {
                displayContent.innerHTML = '<p>No card sets configured for this bulletin.</p>';
                return;
            }
            
            // Get all cards from the specified card sets synchronously
            const allCards = [];
            cardSetIds.forEach(cardSetId => {
                const cardSet = platformData.cardSets.find(cs => cs.id === cardSetId);
                if (cardSet && cardSet.cards) {
                    allCards.push(...cardSet.cards);
                }
            });
            
            // Display combined cards
            if (allCards.length > 0) {
                displayCards(allCards, displayContent);
            } else {
                displayContent.innerHTML = `
                    <p>Card Set Not Found</p>
                    <p>The card set for this bulletin does not exist.</p>
                    <p>Card Set ID: ${cardSetIds.join(', ')}</p>
                    <p>Available Card Sets: ${platformData.cardSets.map(cs => cs.id).join(', ')}</p>
                `;
            }
            break;

        case 'clubs':
            // BULLETIN 8: Clubs display
            const clubSetIds = bulletin.clubSetIds || (bulletin.cardSetIds ? bulletin.cardSetIds : []);
            const clubsPerRow = bulletin.clubsPerRow || 3;
            const showJoinButton = bulletin.showJoinButton || false;
            
            if (clubSetIds.length > 0) {
                // Get all clubs from the specified club sets
                const allClubs = [];
                clubSetIds.forEach(setId => {
                    const clubSet = platformData.clubSets.find(cs => cs.id === setId);
                    if (clubSet && clubSet.clubs) {
                        allClubs.push(...clubSet.clubs.map(club => ({
                            ...club,
                            sourceSetName: clubSet.name
                        })));
                    }
                });
                
                if (allClubs.length > 0) {
                    displayContent.innerHTML = `
                        <div style="width: 100%;">
                            <h2 class="mb-3" style="color: var(--primary); font-size: 1.8rem;">${bulletin.title}</h2>
                            <p class="mb-4" style="color: var(--secondary); font-style: italic; font-size: 1.2rem;">
                                ${platformData.clubSets.find(cs => cs.id === clubSetIds[0])?.subtitle || 'Our valued partners and collaborators'}
                            </p>
                            <p class="mb-4" style="font-size: 1.1rem;">Displaying ${allClubs.length} clubs from ${clubSetIds.length} set${clubSetIds.length > 1 ? 's' : ''}.</p>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(${clubsPerRow === 1 ? '400px' : '280px'}, 1fr)); gap: 1.5rem; margin-top: 2rem;">
                                ${allClubs.map(club => {
                                    // Get club picture if available
                                    const pictureUrl = club.picture ? getCardPictureUrl(club) : null;
                                    
                                    // Create the club card with clickable area
                                    return `
                                        <div class="club-card" style="border: 1px solid #eee; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); transition: all 0.3s; overflow: hidden; cursor: pointer; height: 100%; display: flex; flex-direction: column;"
                                            onclick="window.open('${club.link || '#'}', '_blank')">
                                            
                                            <!-- Club Picture at the Top -->
                                            <div style="width: 100%; height: 150px; background: ${pictureUrl ? `url('${pictureUrl}')` : 'linear-gradient(135deg, var(--primary), var(--accent))'}; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center;"
                                                onerror="this.style.background = 'linear-gradient(135deg, var(--primary), var(--accent))'">
                                                ${!pictureUrl ? `
                                                    <div style="font-size: 3rem; color: white; opacity: 0.8;">
                                                        <i class="${club.icon || 'fas fa-users'}"></i>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            
                                            <div style="padding: 1.5rem; flex-grow: 1; display: flex; flex-direction: column;">
                                                <div style="flex-grow: 1;">
                                                    <h4 style="margin: 0.5rem 0; color: var(--primary); font-size: 1.3rem;">${club.name}</h4>
                                                    ${club.description ? `<p style="color: #555; font-size: 0.95rem; line-height: 1.4; margin-top: 0.8rem;">${club.description}</p>` : ''}
                                                </div>
                                                
                                                ${showJoinButton ? `
                                                    <div style="margin-top: 1.5rem;">
                                                        <button class="btn btn-success" 
                                                                style="width: 100%;"
                                                                onclick="event.stopPropagation(); window.open('${club.link || '#'}', '_blank')">
                                                            <i class="fas fa-sign-in-alt"></i> Join Club
                                                        </button>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                    
                    // Add hover effects
                    setTimeout(() => {
                        document.querySelectorAll('.club-card').forEach(card => {
                            card.addEventListener('mouseenter', function() {
                                this.style.transform = 'translateY(-5px)';
                                this.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
                            });
                            card.addEventListener('mouseleave', function() {
                                this.style.transform = 'translateY(0)';
                                this.style.boxShadow = '0 3px 10px rgba(0,0,0,0.08)';
                            });
                        });
                    }, 0);
                } else {
                    displayContent.innerHTML = `
                        <div class="text-center" style="padding: 4rem; width: 100%;">
                            <h3>No Clubs Available</h3>
                            <p>There are no clubs in the selected club sets.</p>
                            <p>Club Set IDs: ${clubSetIds.join(', ')}</p>
                        </div>
                    `;
                }
            } else {
                displayContent.innerHTML = `
                    <div class="text-center" style="padding: 4rem; width: 100%;">
                        <h3>Club Sets Not Configured</h3>
                        <p>This bulletin needs Club Set IDs configured.</p>
                        <p>Go to <a href="database.html" target="_blank" style="color: var(--primary); text-decoration: underline;">Database Manager</a> to configure club sets.</p>
                    </div>
                `;
            }
            break;
            
        case 'contact':
            // BULLETIN 8: Contact
            displayContent.innerHTML = `
                <div class="text-center" style="padding: 4rem;">
                    <h3 class="mb-3">Contact & Support</h3>
                    <p class="mb-4">Get in touch with us for any questions or support needs.</p>
                    <div class="cards-container">
                        <div class="card">
                            <div class="card-header">Email Support</div>
                            <div class="card-body">
                                <p><i class="fas fa-envelope"></i> support@centernecklace.com</p>
                                <p>We typically respond within 24 hours.</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">Phone Support</div>
                            <div class="card-body">
                                <p><i class="fas fa-phone"></i> +1 (555) 123-4567</p>
                                <p>Monday-Friday, 9AM-5PM EST</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">Office Address</div>
                            <div class="card-body">
                                <p><i class="fas fa-map-marker-alt"></i> 123 Innovation Drive</p>
                                <p>Tech City, TC 12345</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">Documentation</div>
                            <div class="card-body">
                                <p><i class="fas fa-book"></i> User Guides & Tutorials</p>
                                <p>Comprehensive documentation available online.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;
            
        case 'impact':
            // Impact Dashboard
            const impactSet = platformData.yearsSets.find(ys => ys.id === bulletin.yearsSetId);
            if (impactSet && impactSet.years && impactSet.years.length > 0) {
                const totalDonation = impactSet.years.reduce((sum, year) => 
                    sum + (year.donations ? year.donations.reduce((donationSum, donation) => donationSum + (donation.amount || 0), 0) : 0), 0);
                const totalEvents = impactSet.years.reduce((sum, year) => sum + (year.events ? year.events.length : 0), 0);
                const totalAttendees = impactSet.years.reduce((sum, year) => 
                    sum + (year.events ? year.events.reduce((eventSum, event) => eventSum + (event.attendees || 0), 0) : 0), 0);
                
                displayContent.innerHTML = `
                    <div class="bulletin-1">
                        <div class="scrolling-bg"></div>
                        <div class="story-display">
                            <h3 class="mb-2">Our Impact Over ${impactSet.years.length} Years</h3>
                            
                            <div class="impact-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin: 2rem 0;">
                                <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 800; color: var(--success);">$${totalDonation.toLocaleString()}</div>
                                    <div style="font-size: 0.9rem; color: #666;">Total Donations</div>
                                </div>
                                <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 800; color: var(--primary);">${impactSet.years.length}</div>
                                    <div style="font-size: 0.9rem; color: #666;">Years of Impact</div>
                                </div>
                                <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 800; color: var(--accent);">${totalEvents}</div>
                                    <div style="font-size: 0.9rem; color: #666;">Community Events</div>
                                </div>
                                <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center;">
                                    <div style="font-size: 2rem; font-weight: 800; color: var(--warning);">${totalAttendees.toLocaleString()}</div>
                                    <div style="font-size: 0.9rem; color: #666;">Total Attendees</div>
                                </div>
                            </div>
                            
                            <h4 class="mt-4 mb-2">Year-by-Year Breakdown</h4>
                            <div class="year-breakdown" style="max-height: 300px; overflow-y: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8f9fa;">
                                            <th style="padding: 1rem; text-align: left;">Year</th>
                                            <th style="padding: 1rem; text-align: left;">Donations</th>
                                            <th style="padding: 1rem; text-align: left;">Events</th>
                                            <th style="padding: 1rem; text-align: left;">Progress</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${impactSet.years.map(year => {
                                            const yearDonation = year.donations ? year.donations.reduce((sum, donation) => sum + (donation.amount || 0), 0) : 0;
                                            const maxDonation = Math.max(...impactSet.years.map(y => 
                                                y.donations ? y.donations.reduce((sum, donation) => sum + (donation.amount || 0), 0) : 0
                                            ));
                                            const progressWidth = maxDonation > 0 ? (yearDonation / maxDonation * 100) : 0;
                                            return `
                                                <tr style="border-bottom: 1px solid #eee;">
                                                    <td style="padding: 1rem; font-weight: 600;">${year.year}</td>
                                                    <td style="padding: 1rem;">$${yearDonation.toLocaleString()}</td>
                                                    <td style="padding: 1rem;">${year.events ? year.events.length : 0}</td>
                                                    <td style="padding: 1rem;">
                                                        <div style="width: 100%; background: #e9ecef; height: 8px; border-radius: 4px;">
                                                            <div style="width: ${progressWidth}%; 
                                                                background: linear-gradient(90deg, var(--success), #64dd17); height: 100%; border-radius: 4px;"></div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <p class="mt-4">This dashboard shows our community impact over ${impactSet.years.length} years. 
                            Data is managed through the Years Sets in the database.</p>
                        </div>
                        <div class="number-display">
                            <div>${impactSet.years.length}</div>
                            <div class="number-label">Years</div>
                        </div>
                    </div>
                `;
            } else {
                displayContent.innerHTML = `
                    <div class="text-center" style="padding: 4rem;">
                        <h3>No Impact Data Available</h3>
                        <p>Please select a Years Set in the database for this bulletin.</p>
                    </div>
                `;
            }
            break;
            
        case 'events':
            // Events Gallery
            const eventsSet = platformData.yearsSets.find(ys => ys.id === bulletin.yearsSetId);
            if (eventsSet && eventsSet.years && eventsSet.years.length > 0) {
                // Collect all events from all years
                const allEvents = [];
                eventsSet.years.forEach(yearData => {
                    if (yearData.events && yearData.events.length > 0) {
                        yearData.events.forEach(event => {
                            allEvents.push({
                                ...event,
                                year: yearData.year
                            });
                        });
                    }
                });
                
                if (allEvents.length > 0) {
                    displayContent.innerHTML = `
                        <h3 class="mb-3">${bulletin.title}</h3>
                        <p class="mb-3">Browse ${allEvents.length} events from ${eventsSet.years.length} years of community engagement.</p>
                        
                        <div class="year-nav mb-4">
                            <div class="year-btn active" data-filter="all">All Events</div>
                            ${eventsSet.years.map(year => `
                                <div class="year-btn" data-filter="${year.year}">${year.year}</div>
                            `).join('')}
                        </div>
                        
                        <div id="eventsGallery" class="cards-container">
                            ${allEvents.map(event => {
                                const eventPictures = event.pictures || [];
                                const hasPictures = eventPictures.length > 0;
                                
                                return `
                                    <div class="card event-card" data-year="${event.year}">
                                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>${event.name || 'Unnamed Event'}</span>
                                            <div>
                                                <small style="font-size: 0.8rem; color: #666;">${event.year}</small>
                                                ${hasPictures ? 
                                                    `<span style="margin-left: 0.5rem; background: var(--success); color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">
                                                        <i class="fas fa-images"></i> ${eventPictures.length}
                                                    </span>` 
                                                    : ''
                                                }
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Date:</strong> ${event.date ? new Date(event.date).toLocaleDateString() : 'No date specified'}</p>
                                            <p>${event.description || 'No description available.'}</p>
                                            <p><strong>Attendees:</strong> ${event.attendees || 0}</p>
                                            
                                            ${hasPictures ? `
                                                <div style="margin-top: 1rem;">
                                                    <h6 style="margin-bottom: 0.5rem;">Event Pictures (${eventPictures.length})</h6>
                                                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; max-height: 150px; overflow-y: auto; padding: 0.5rem; background: #f9f9f9; border-radius: 8px;">
                                                        ${eventPictures.map(pictureId => {
                                                            const picture = getPictureFromFolder(pictureId);
                                                            if (picture) {
                                                                const imgSrc = picture.path || `./picture/${picture.fileName}`;
                                                                return `
                                                                    <div style="width: 50px; height: 50px; cursor: pointer;" onclick="previewPicture('${pictureId}')">
                                                                        <img src="${imgSrc}" 
                                                                            alt="${picture.fileName}"
                                                                            style="width: 100%; height: 100%; object-fit: cover; border-radius: 3px;"
                                                                            onerror="this.src='https://via.placeholder.com/50x50?text=Image'">
                                                                    </div>
                                                                `;
                                                            }
                                                            return `
                                                                <div style="width: 50px; height: 50px; background: #eee; border-radius: 3px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 0.7rem;">
                                                                    <i class="fas fa-image"></i>
                                                                </div>
                                                            `;
                                                        }).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    
                    // Add event listeners to filter buttons
                    setTimeout(() => {
                        document.querySelectorAll('#displayContent .year-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                document.querySelectorAll('#displayContent .year-btn').forEach(b => b.classList.remove('active'));
                                btn.classList.add('active');
                                
                                const filter = btn.dataset.filter;
                                const eventCards = document.querySelectorAll('.event-card');
                                
                                eventCards.forEach(card => {
                                    if (filter === 'all' || card.dataset.year === filter) {
                                        card.style.display = 'block';
                                    } else {
                                        card.style.display = 'none';
                                    }
                                });
                            });
                        });
                    }, 0);
                } else {
                    displayContent.innerHTML = `
                        <div class="text-center" style="padding: 4rem;">
                            <h3>No Events Available</h3>
                            <p>There are no events in the selected Years Set.</p>
                        </div>
                    `;
                }
            } else {
                displayContent.innerHTML = `
                    <div class="text-center" style="padding: 4rem;">
                        <h3>No Events Data Available</h3>
                        <p>Please select a Years Set in the database for this bulletin.</p>
                    </div>
                `;
            }
            break;
            
        default:
            displayContent.innerHTML = `
                <div class="text-center" style="padding: 4rem;">
                    <h3>Unknown Bulletin Type</h3>
                    <p>The bulletin type "${bulletin.type}" is not recognized.</p>
                    <p>Please check the database configuration.</p>
                </div>
            `;
    }
}

// Function to display cards
function displayCards(cards, container) {
    container.innerHTML = '';
    
    if (cards.length === 0) {
        container.innerHTML = '<p>No cards to display.</p>';
        return;
    }
    
    const cardsHTML = cards.map(card => {
        const pictureHtml = getCardPictureHTML(card, 120);
        const safeName = escapeHtml(card.name);
        const safeTitle = card.title ? escapeHtml(card.title) : '';
        const safeIntroduction = card.introduction ? escapeHtml(card.introduction) : '';
        const cardData = JSON.stringify(card).replace(/'/g, "&#39;");
        
        return `
            <div class="card clickable" 
                style="border: 1px solid #eee; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); overflow: hidden; transition: all 0.3s; cursor: pointer; display: flex; flex-direction: column; padding: 1rem;"
                data-card='${cardData}'>
                ${pictureHtml}
                <div style="margin-top: 1rem; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; width: 100%;">
                    <div>
                        <h4 style="margin: 0.5rem 0; color: var(--primary); font-size: 1.1rem;">${safeName}</h4>
                        ${safeTitle ? `<p style="font-weight: 600; color: var(--secondary); margin-bottom: 0.5rem; font-size: 0.95rem;">${safeTitle}</p>` : ''}
                        ${safeIntroduction ? `<p style="color: #555; font-size: 0.9rem; line-height: 1.4; margin-top: 0.8rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">${safeIntroduction}</p>` : ''}
                        ${!safeTitle && !safeIntroduction ? '<p style="color: #888; font-style: italic; margin-top: 0.8rem;">Member of our community.</p>' : ''}
                    </div>
                    <div style="margin-top: 1rem; color: var(--primary); font-size: 0.8rem;">
                        <i class="fas fa-eye"></i> Click to view details
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
            ${cardsHTML}
        </div>
    `;
}

function loadCardSet(cardSetId) {
    return new Promise((resolve, reject) => {
        const cardSet = platformData.cardSets.find(cs => cs.id === cardSetId);
        if (cardSet) {
            resolve(cardSet);
        } else {
            reject(new Error(`Card set ${cardSetId} not found`));
        }
    });
}

    // Sort bulletins by ID
    function sortBulletins() {
        platformData.bulletins.sort((a, b) => a.id - b.id);
    }

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Helper function to get picture URL from card
function getCardPictureUrl(card) {
    if (!card.picture) {
        return `https://via.placeholder.com/300x300?text=No+Image`;
    }
    
    if (card.picture.startsWith('./picture/')) {
        return card.picture;
    }
    
    const picture = getPictureFromFolder(card.picture);
    if (picture) {
        return picture.path || `./picture/${picture.fileName}`;
    }
    
    return `https://via.placeholder.com/300x300?text=${encodeURIComponent(card.name.substring(0, 10))}`;
}

// Helper function to get card picture HTML
function getCardPictureHTML(card, size = 80) {
    let pictureUrl = getCardPictureUrl(card);
    const pictureId = `card-picture-${card.id}`;
    
    // Use a simpler onerror that calls a function
    const onErrorFunc = `handleCardImageError(this, ${size})`;
    
    return `
        <div class="card-picture" data-picture-id="${pictureId}" 
             data-card-name="${escapeHtml(card.name)}"
             data-card-title="${escapeHtml(card.title || '')}"
             data-card-intro="${escapeHtml(card.introduction || '')}"
             data-picture-url="${pictureUrl}"
             style="text-align: center; padding: 0.5rem; cursor: pointer;">
            <img src="${pictureUrl}" 
                 alt="${card.name}" 
                 style="width: ${size}px; height: ${size}px; object-fit: cover; 
                        border-radius: ${size >= 100 ? '10px' : '50%'}; 
                        border: ${size >= 100 ? '3px solid var(--primary)' : '2px solid var(--primary)'}; 
                        cursor: pointer; transition: transform 0.2s;"
                 onmouseover="this.style.transform='scale(1.05)'"
                 onmouseout="this.style.transform='scale(1)'"
                 onerror="${onErrorFunc}">
        </div>
    `;
}

// Add this function to handle image errors
function handleCardImageError(imgElement, size) {
    imgElement.style.display = 'none';
    const borderRadius = size >= 100 ? '10px' : '50%';
    imgElement.parentElement.innerHTML = 
        `<div style="width:${size}px; height:${size}px; border-radius:${borderRadius}; background:#eee; display:flex; align-items:center; justify-content:center; color:#999;">
            <i class="fas fa-user"></i>
        </div>`;
}

// Function to enlarge card picture
function enlargeCardPicture(event, name, title, introduction, pictureUrl) {
    event.preventDefault();
    event.stopPropagation();
    
    const modal = document.getElementById('imagePreviewModal');
    const previewImage = document.getElementById('previewImage');
    const previewImageTitle = document.getElementById('previewImageTitle');
    const previewImageDescription = document.getElementById('previewImageDescription');
    
    // Set the image source
    previewImage.src = pictureUrl;
    previewImage.alt = name;
    
    // Set the title and description
    previewImageTitle.textContent = name;
    
    let description = '';
    if (title) {
        description += `<strong>Title:</strong> ${title}<br>`;
    }
    if (introduction) {
        description += `<strong>Description:</strong> ${introduction}<br>`;
    }
    
    previewImageDescription.innerHTML = description;
    
    showModal('imagePreviewModal');
    
    // Add click outside to close
    modal.onclick = function(e) {
        if (e.target === modal) {
            closeImagePreview();
        }
    };
}

// Function to close the image preview
function closeImagePreview() {
    hideModal('imagePreviewModal');
}

// Function to show card details in modal
function showCardDetails(card) {
    const modal = document.getElementById('detailsModal');
    const modalTitle = document.getElementById('modalItemTitle');
    const modalSubtitle = document.getElementById('modalItemSubtitle');
    const modalImage = document.getElementById('modalImage');
    const modalImageSection = document.getElementById('modalImageSection');
    const modalDetails = document.getElementById('modalItemDetails');
    
    // Hide all special sections
    document.getElementById('modalYearDetails').classList.add('hidden');
    document.getElementById('modalDonationDetails').classList.add('hidden');
    document.getElementById('modalEventDetails').classList.add('hidden');
    document.getElementById('modalEventPictures').classList.add('hidden');
    
    // Set title
    modalTitle.textContent = card.name;
    
    // Set subtitle if exists
    if (card.title) {
        modalSubtitle.innerHTML = `<strong>Title:</strong> ${card.title}`;
        modalSubtitle.classList.remove('hidden');
    } else {
        modalSubtitle.classList.add('hidden');
    }
    
    // Set details (introduction)
    if (card.introduction) {
        modalDetails.innerHTML = `<p style="line-height: 1.6;">${card.introduction}</p>`;
    } else {
        modalDetails.innerHTML = '<p style="color: #666; font-style: italic;">No additional information available.</p>';
    }
    
    // Handle image
    if (card.picture) {
        const pictureUrl = getCardPictureUrl(card);
        modalImage.src = pictureUrl;
        modalImage.alt = card.name;
        modalImageSection.classList.remove('hidden');
    } else {
        modalImageSection.classList.add('hidden');
    }
    
// Show modal
    showModal('detailsModal');
}
    // Function to handle picture clicks
    function handlePictureClick(event) {
        const pictureElement = event.target.closest('.card-picture');
        if (pictureElement) {
            event.preventDefault();
            event.stopPropagation();
            
            const name = pictureElement.getAttribute('data-card-name');
            const title = pictureElement.getAttribute('data-card-title');
            const introduction = pictureElement.getAttribute('data-card-intro');
            const pictureUrl = pictureElement.getAttribute('data-picture-url');
            
            enlargeCardPicture(event, name, title, introduction, pictureUrl);
        }
    }

    // Add event delegation for picture clicks
    document.addEventListener('click', function(event) {
        handlePictureClick(event);
    });

 // Function to handle card clicks
function handleCardClick(event) {
    // Check if the clicked element or its parent has the 'card clickable' class
    let cardElement = event.target.closest('.card.clickable');
    
    if (cardElement) {
        event.preventDefault();
        event.stopPropagation();
        
        // Check for donation data (from donation cards)
        const donationData = cardElement.getAttribute('data-donation');
        const donationYear = cardElement.getAttribute('data-year');
        
        if (donationData && donationYear) {
            try {
                const donation = JSON.parse(donationData.replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
                showDonationDetails(donation, parseInt(donationYear));
                return;
            } catch (e) {
                console.error('Error parsing donation data:', e);
            }
        }
        
        // Check for event data (from event cards)
        const eventData = cardElement.getAttribute('data-event');
        const eventYear = cardElement.getAttribute('data-year');
        
        if (eventData && eventYear) {
            try {
                const eventObj = JSON.parse(eventData.replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
                showEventDetails(eventObj, parseInt(eventYear));
                return;
            } catch (e) {
                console.error('Error parsing event data:', e);
            }
        }
        
        // Finally, try to get regular card data
        const cardDataStr = cardElement.getAttribute('data-card');
        if (cardDataStr) {
            try {
                const card = JSON.parse(cardDataStr.replace(/&#39;/g, "'"));
                showCardDetails(card);
            } catch (e) {
                console.error('Error parsing card data:', e);
            }
        }
    }
}

    // Add event delegation for card clicks
    document.addEventListener('click', function(event) {
        handleCardClick(event);
    });

// Function to handle year item clicks
function handleYearItemClick(event) {
    let yearElement = event.target.closest('.clickable-item');
    
    if (yearElement) {
        event.preventDefault();
        event.stopPropagation();
        
        // Check if it's a year item (has data-year)
        const yearDataStr = yearElement.getAttribute('data-year');
        if (yearDataStr) {
            // Find the year data from platformData
            const yearsSet = platformData.yearsSets[0]; // Assuming first years set
            if (yearsSet) {
                const yearData = yearsSet.years.find(y => y.year === parseInt(yearDataStr));
                if (yearData) {
                    showYearDetails(yearData);
                }
            }
        }
    }
}

// Add event listener for year item clicks
document.addEventListener('click', handleYearItemClick);

// Function to handle all clickable items
function handleAllClickableItems(event) {
    // Try card clicks first
    handleCardClick(event);
    
    // Then try donation/event item clicks
    handleDonationEventClick(event);
    
    // Check for picture clicks
    handlePictureClick(event);
}

// Update the event listener
document.removeEventListener('click', handleCardClick);
document.removeEventListener('click', handleDonationEventClick);
document.removeEventListener('click', handlePictureClick);
document.addEventListener('click', handleAllClickableItems);

    // Function to setup event listeners for dynamically generated content
    function setupDynamicEventListeners() {
        // Remove any existing listeners to avoid duplicates
        const displayContent = document.getElementById('displayContent');
        if (displayContent) {
            // We'll use event delegation on the document instead
        }
        
        // Setup modal close buttons
        const closeDetailsBtn = document.getElementById('closeDetailsModal');
        if (closeDetailsBtn) {
            closeDetailsBtn.addEventListener('click', closeDetailsModal);
        }
        
        const closeImageBtn = document.getElementById('closeImagePreview');
        if (closeImageBtn) {
            closeImageBtn.addEventListener('click', closeImagePreview);
        }
        
        // Setup Escape key to close modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDetailsModal();
                closeImagePreview();
            }
        });
    }

// Function to show year details in modal
function showYearDetails(yearData) {
    const modal = document.getElementById('detailsModal');
    const modalTitle = document.getElementById('modalItemTitle');
    const modalYearDetails = document.getElementById('modalYearDetails');
    
    // Hide other sections
    document.getElementById('modalItemSubtitle').classList.add('hidden');
    document.getElementById('modalImageSection').classList.add('hidden');
    document.getElementById('modalDonationDetails').classList.add('hidden');
    document.getElementById('modalEventDetails').classList.add('hidden');
    document.getElementById('modalEventPictures').classList.add('hidden');
    
    // Set title
    modalTitle.textContent = `Year ${yearData.year} Summary`;
    
    // Calculate totals
    const totalDonation = yearData.donations ? 
        yearData.donations.reduce((sum, donation) => sum + (donation.amount || 0), 0) : 0;
    const totalEvents = yearData.events ? yearData.events.length : 0;
    
    // Build year details
    let yearHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
            <div style="background: #f0f7ff; padding: 1rem; border-radius: 8px;">
                <div style="font-size: 1.2rem; font-weight: 600; color: var(--primary);">Year</div>
                <div style="font-size: 2rem; font-weight: 800; color: var(--primary);">${yearData.year}</div>
            </div>
            <div style="background: #f0f9f0; padding: 1rem; border-radius: 8px;">
                <div style="font-size: 1.2rem; font-weight: 600; color: var(--success);">Total Donations</div>
                <div style="font-size: 1.8rem; font-weight: 800; color: var(--success);">$${totalDonation.toLocaleString()}</div>
            </div>
            <div style="background: #fff3e0; padding: 1rem; border-radius: 8px;">
                <div style="font-size: 1.2rem; font-weight: 600; color: var(--warning);">Events</div>
                <div style="font-size: 1.8rem; font-weight: 800; color: var(--warning);">${totalEvents}</div>
            </div>
        </div>
    `;
    
// In showYearDetails function, update the clickable items:
if (yearData.donations && yearData.donations.length > 0) {
    yearHTML += `
        <h4 style="margin: 1.5rem 0 1rem 0;">Donations</h4>
        <div style="max-height: 200px; overflow-y: auto;">
            ${yearData.donations.map(donation => `
                <div class="clickable-item donation-item" 
                     data-donation='${JSON.stringify(donation).replace(/'/g, "&#39;")}'
                     data-year="${yearData.year}"
                     style="padding: 0.8rem; margin-bottom: 0.5rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid var(--success); cursor: pointer;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--success);">$${(donation.amount || 0).toLocaleString()}</strong>
                            ${donation.notes ? `<div style="font-size: 0.9rem; color: #666;">${donation.notes}</div>` : ''}
                        </div>
                        <i class="fas fa-chevron-right" style="color: #999;"></i>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

if (yearData.events && yearData.events.length > 0) {
    yearHTML += `
        <h4 style="margin: 1.5rem 0 1rem 0;">Events</h4>
        <div style="max-height: 300px; overflow-y: auto;">
            ${yearData.events.map(event => `
                <div class="clickable-item event-item" 
                     data-event='${JSON.stringify(event).replace(/'/g, "&#39;")}'
                     data-year="${yearData.year}"
                     style="padding: 1rem; border: 1px solid #eee; border-radius: 8px; margin-bottom: 1rem; cursor: pointer; transition: all 0.2s;"
                     onmouseover="this.style.backgroundColor='#f8f9fa'"
                     onmouseout="this.style.backgroundColor='transparent'">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <div>
                            <strong style="color: var(--primary);">${event.name || 'Unnamed Event'}</strong>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 0.2rem;">
                                ${event.date ? new Date(event.date).toLocaleDateString() : 'No date'}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            ${event.pictures && event.pictures.length > 0 ? 
                                `<span style="background: var(--success); color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.8rem;">
                                    <i class="fas fa-images"></i> ${event.pictures.length}
                                </span>` : ''}
                            <i class="fas fa-chevron-right" style="color: #999;"></i>
                        </div>
                    </div>
                    ${event.description ? `<div style="color: #555; font-size: 0.95rem;">${event.description}</div>` : ''}
                </div>
            `).join('')}
        </div>
    `;
}
    
    // Add events section if exists
    if (yearData.events && yearData.events.length > 0) {
        yearHTML += `
            <h4 style="margin: 1.5rem 0 1rem 0;">Events</h4>
            <div style="max-height: 300px; overflow-y: auto;">
                ${yearData.events.map(event => `
                    <div class="clickable-item event-item" data-event='${JSON.stringify(event).replace(/'/g, "&#39;")}'
                     data-year="${yearData.year}"
                     style="padding: 1rem; border: 1px solid #eee; border-radius: 8px; margin-bottom: 1rem; cursor: pointer; transition: all 0.2s;"
                     onmouseover="this.style.backgroundColor='#f8f9fa'"
                     onmouseout="this.style.backgroundColor='transparent'">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                            <div>
                                <strong style="color: var(--primary);">${event.name || 'Unnamed Event'}</strong>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.2rem;">
                                    ${event.date ? new Date(event.date).toLocaleDateString() : 'No date'}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                ${event.pictures && event.pictures.length > 0 ? 
                                    `<span style="background: var(--success); color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.8rem;">
                                        <i class="fas fa-images"></i> ${event.pictures.length}
                                    </span>` : ''}
                                <i class="fas fa-chevron-right" style="color: #999;"></i>
                            </div>
                        </div>
                        ${event.description ? `<div style="color: #555; font-size: 0.95rem;">${event.description}</div>` : ''}
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    modalYearDetails.innerHTML = yearHTML;
    modalYearDetails.classList.remove('hidden');
    modalDetails.innerHTML = ''; // Clear general details
    
    // Show modal
    modal.classList.remove('hidden');
}

// Function to handle donation and event item clicks
function handleDonationEventClick(event) {
    // Check for donation items
    let donationElement = event.target.closest('.donation-item, .card.clickable[data-donation]');
    // Check for event items
    let eventElement = event.target.closest('.event-item, .card.clickable[data-event]');
    
    if (donationElement) {
        event.preventDefault();
        event.stopPropagation();
        
        const donationData = donationElement.getAttribute('data-donation');
        const year = donationElement.getAttribute('data-year');
        
        if (donationData && year) {
            try {
                // Unescape the JSON
                const unescapedData = donationData
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'");
                const donation = JSON.parse(unescapedData);
                showDonationDetails(donation, parseInt(year));
            } catch (e) {
                console.error('Error parsing donation data:', e);
                console.log('Raw donation data:', donationData);
            }
        }
    }
    
    if (eventElement) {
        event.preventDefault();
        event.stopPropagation();
        
        const eventData = eventElement.getAttribute('data-event');
        const year = eventElement.getAttribute('data-year');
        
        if (eventData && year) {
            try {
                // Unescape the JSON
                const unescapedData = eventData
                    .replace(/&quot;/g, '"')
                    .replace(/&#39;/g, "'");
                const eventObj = JSON.parse(unescapedData);
                showEventDetails(eventObj, parseInt(year));
            } catch (e) {
                console.error('Error parsing event data:', e);
                console.log('Raw event data:', eventData);
            }
        }
    }
}

// Add event delegation for donation and event item clicks
document.addEventListener('click', function(event) {
    handleDonationEventClick(event);
});

// Function to show donation details
function showDonationDetails(donation, year) {
    const modal = document.getElementById('detailsModal');
    const modalTitle = document.getElementById('modalItemTitle');
    const modalDetails = document.getElementById('modalItemDetails'); // Add this
    const modalDonationDetails = document.getElementById('modalDonationDetails');
    
    // Hide other sections
    document.getElementById('modalItemSubtitle').classList.add('hidden');
    document.getElementById('modalImageSection').classList.add('hidden');
    document.getElementById('modalYearDetails').classList.add('hidden');
    document.getElementById('modalEventDetails').classList.add('hidden');
    document.getElementById('modalEventPictures').classList.add('hidden');
    
    // Set title
    modalTitle.textContent = `Donation Details`;
    
    // Build donation details
    const donationHTML = `
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
            <div style="font-size: 2.5rem; font-weight: 800; color: var(--success); text-align: center; margin-bottom: 1rem;">
                $${(donation.amount || 0).toLocaleString()}
            </div>
            <div style="text-align: center; color: #666; margin-bottom: 1.5rem;">Donation Amount</div>
            
            <div style="display: grid; gap: 1rem;">
                <div>
                    <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.3rem;">Year</div>
                    <div style="font-size: 1.1rem;">${year}</div>
                </div>
                
                ${donation.id ? `
                    <div>
                        <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.3rem;">Donation ID</div>
                        <div style="font-size: 1.1rem;">${donation.id}</div>
                    </div>
                ` : ''}
                
                ${donation.notes ? `
                    <div>
                        <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.3rem;">Notes</div>
                        <div style="font-size: 1.1rem; line-height: 1.5;">${donation.notes}</div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;

    modalDonationDetails.innerHTML = donationHTML;
    modalDonationDetails.classList.remove('hidden');
    
    // Clear general details section
    if (modalDetails) {
        modalDetails.innerHTML = '';
    }
    
    // Show modal
    showModal('detailsModal');
}

// Function to show event details
function showEventDetails(event, year) {
    const modal = document.getElementById('detailsModal');
    const modalTitle = document.getElementById('modalItemTitle');
    const modalDetails = document.getElementById('modalItemDetails');
    const modalEventDetails = document.getElementById('modalEventDetails');
    const modalEventPictures = document.getElementById('modalEventPictures');
    const modalEventPicturesGallery = document.getElementById('modalEventPicturesGallery');
    
    // Hide other sections
    document.getElementById('modalItemSubtitle').classList.add('hidden');
    document.getElementById('modalImageSection').classList.add('hidden');
    document.getElementById('modalYearDetails').classList.add('hidden');
    document.getElementById('modalDonationDetails').classList.add('hidden');
    
    // Set title
    modalTitle.textContent = event.name || 'Event Details';
    
    // Build event details
    const eventHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
            <div style="background: #f0f7ff; padding: 1.2rem; border-radius: 8px;">
                <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">Year</div>
                <div style="font-size: 1.2rem;">${year}</div>
            </div>
            
            ${event.date ? `
                <div style="background: #fff3e0; padding: 1.2rem; border-radius: 8px;">
                    <div style="font-weight: 600; color: var(--warning); margin-bottom: 0.5rem;">Date</div>
                    <div style="font-size: 1.2rem;">${new Date(event.date).toLocaleDateString()}</div>
                </div>
            ` : ''}
            
            ${event.attendees ? `
                <div style="background: #f0f9f0; padding: 1.2rem; border-radius: 8px;">
                    <div style="font-weight: 600; color: var(--success); margin-bottom: 0.5rem;">Attendees</div>
                    <div style="font-size: 1.2rem;">${event.attendees.toLocaleString()}</div>
                </div>
            ` : ''}
        </div>
        
        ${event.location ? `
            <div style="margin-bottom: 1rem;">
                <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">Location</div>
                <div style="font-size: 1.1rem;"><i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i>${event.location}</div>
            </div>
        ` : ''}
        
        ${event.description ? `
            <div style="margin-bottom: 1.5rem;">
                <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">Description</div>
                <div style="font-size: 1.1rem; line-height: 1.5;">${event.description}</div>
            </div>
        ` : ''}
    `;
    
    modalEventDetails.innerHTML = eventHTML;
    modalEventDetails.classList.remove('hidden');
    
    // Handle event pictures
    const eventPictures = event.pictures || [];
    if (eventPictures.length > 0) {
        modalEventPicturesGallery.innerHTML = eventPictures.map(pictureId => {
            const picture = getPictureFromFolder(pictureId);
            if (picture) {
                const imgSrc = picture.path || `./picture/${picture.fileName}`;
                return `
                    <div class="picture-item" onclick="previewPicture('${pictureId}')" style="cursor: pointer;">
                        <img src="${imgSrc}" 
                             alt="${picture.fileName}"
                             style="width: 100px; height: 100px; object-fit: cover; border-radius: 5px;"
                             onerror="this.src='https://via.placeholder.com/100x100?text=Image'">
                        <div style="font-size: 0.7rem; margin-top: 0.2rem; word-break: break-all;">
                            ${picture.fileName.substring(0, 10)}${picture.fileName.length > 10 ? '...' : ''}
                        </div>
                    </div>
                `;
            }
            return `
                <div style="width: 100px; height: 100px; background: #eee; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: #999;">
                    <i class="fas fa-image"></i>
                </div>
            `;
        }).join('');
        
        modalEventPictures.classList.remove('hidden');
    } else {
        modalEventPictures.classList.add('hidden');
    }
    
    modalDetails.innerHTML = ''; // Clear general details
    
    // Show modal
    showModal('detailsModal');
}

// Function to close details modal
function closeDetailsModal() {
    hideModal('detailsModal');
}

// Update the initialization to handle the new modal
document.addEventListener('DOMContentLoaded', function() {
    // Close button for details modal
    const closeDetailsBtn = document.getElementById('closeDetailsModal');
    if (closeDetailsBtn) {
        closeDetailsBtn.addEventListener('click', closeDetailsModal);
    }
    
    // Close modal when clicking outside
    const modal = document.getElementById('detailsModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeDetailsModal();
            }
        });
    }
    
    // Close with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeDetailsModal();
            closeImagePreview();
        }
    });
});

// Helper function to show donations only (for bulletin 2)
 function showDonationsOnly(yearData, yearDetails) {
    const donationsCount = yearData.donations ? yearData.donations.length : 0;
    const totalDonation = yearData.donations ? yearData.donations.reduce((sum, donation) => sum + (donation.amount || 0), 0) : 0;
    
    yearDetails.innerHTML = `
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <div>
                <h3 class="mb-2">${yearData.year} - Donations</h3>
                
                ${donationsCount > 0 ? `
                    <div class="mt-4">
                        <h4 class="mb-2">Donations in ${yearData.year}</h4>
                        <div class="cards-container">
                            ${yearData.donations.map(donation => {
                                // Escape the JSON for HTML attribute
                                const donationData = JSON.stringify(donation)
                                    .replace(/"/g, '&quot;')
                                    .replace(/'/g, '&#39;');
                                
                                return `
                                    <div class="card clickable donation-item" 
                                         data-donation="${donationData}"
                                         data-year="${yearData.year}">
                                        <div class="card-header">
                                            <span>Donation ${donation.id || ''}</span>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Amount:</strong> $${donation.amount || 0}</p>
                                            <p><strong>Notes:</strong> ${donation.notes || 'No notes'}</p>
                                            <div style="color: var(--primary); font-size: 0.9rem; margin-top: 0.5rem;">
                                                <i class="fas fa-eye"></i> Click for details
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : '<p class="mb-4" style="color: #666; font-style: italic;">No donations recorded for this year.</p>'}
            </div>
            <div>
                <h4 class="mb-2">Year Statistics</h4>
                <div style="background: white; padding: 1.5rem; border-radius: 10px; border: 1px solid #eee;">
                    <div style="margin-bottom: 1rem;">
                        <div style="font-size: 0.9rem; color: #666;">Total Donations</div>
                        <div style="font-size: 1.5rem; font-weight: 600;">$${totalDonation.toLocaleString()}</div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <div style="font-size: 0.9rem; color: #666;">Number of Donations</div>
                        <div style="font-size: 1.5rem; font-weight: 600;">${donationsCount}</div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

    // Helper function to show events only (for bulletin 3)
function showEventsOnly(yearData) {
    const eventsCount = yearData.events ? yearData.events.length : 0;
    const totalPictures = yearData.events ? 
        yearData.events.reduce((sum, event) => sum + ((event.pictures && event.pictures.length) || 0), 0) : 0;
    
    const yearDetailsElement = document.getElementById('yearDetails');
    if (!yearDetailsElement) {
        showYearDetails(yearData);
        return;
    }
    
    yearDetailsElement.innerHTML = `
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <div>
                <h3 class="mb-2">${yearData.year} - Events</h3>
                
                ${eventsCount > 0 ? `
                    <div class="mt-4">
                        <h4 class="mb-2">Events in ${yearData.year} with Pictures</h4>
                        <div class="cards-container">
                            ${yearData.events.map(event => {
                                const eventPictures = event.pictures || [];
                                const hasPictures = eventPictures.length > 0;
                                
                                // Escape the event data properly
                                const eventData = JSON.stringify(event)
                                    .replace(/"/g, '&quot;')
                                    .replace(/'/g, '&#39;');
                                
                                return `
                                    <div class="card clickable event-item" 
                                         data-event="${eventData}"
                                         data-year="${yearData.year}">
                                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>${event.name || 'Unnamed Event'}</span>
                                            <div>
                                                <small style="font-size: 0.8rem; color: #666;">
                                                    ${event.date ? new Date(event.date).toLocaleDateString() : 'No date'}
                                                </small>
                                                ${hasPictures ? 
                                                    `<span style="margin-left: 0.5rem; background: var(--success); color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">
                                                        <i class="fas fa-images"></i> ${eventPictures.length}
                                                    </span>` 
                                                    : ''
                                                }
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Description:</strong> ${event.description || 'No description'}</p>
                                            <p><strong>Location:</strong> ${event.location || 'Not specified'}</p>
                                            <p><strong>Attendees:</strong> ${event.attendees || 0}</p>
                                            <div style="color: var(--primary); font-size: 0.9rem; margin-top: 0.5rem;">
                                                <i class="fas fa-eye"></i> Click for details
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : '<p class="mb-4" style="color: #666; font-style: italic;">No events recorded for this year.</p>'}
            </div>
            <div>
                <h4 class="mb-2">Year Statistics</h4>
                <div style="background: white; padding: 1.5rem; border-radius: 10px; border: 1px solid #eee;">
                    <div style="margin-bottom: 1rem;">
                        <div style="font-size: 0.9rem; color: #666;">Events Held</div>
                        <div style="font-size: 1.5rem; font-weight: 600;">${eventsCount}</div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <div style="font-size: 0.9rem; color: #666;">Total Pictures</div>
                        <div style="font-size: 1.5rem; font-weight: 600;">${totalPictures}</div>
                    </div>
                </div>
            </div>
        </div>
    `;
}


    // Function to reload data from database
    function reloadFromDatabase() {
        const saved = localStorage.getItem('centerNecklaceDatabase');
        if (saved) {
            try {
                platformData = JSON.parse(saved);
                console.log('Data reloaded from database');
                
                // Reinitialize with new data
                totalBulletins = platformData.bulletins.length;
                
                // If current active bulletin doesn't exist anymore, go to first
                if (!platformData.bulletins.some(b => b.id === activeBulletin) && platformData.bulletins.length > 0) {
                    activeBulletin = platformData.bulletins[0].id;
                }
                
                // Reinitialize everything
                initializeNecklace();
                updateDisplay(activeBulletin);
                updateNavigationStates();
                
                showNotification('Data reloaded successfully!', 'success');
            } catch (e) {
                console.error('Error reloading data:', e);
            }
        }
    }

    // Sign-in Modal Functionality
    signinBtn.addEventListener('click', () => {
        signinModal.classList.add('active');
    });
    
    // Close modal
    document.getElementById('closeModal').addEventListener('click', () => {
        signinModal.classList.remove('active');
    });
    
    // Close modal when clicking outside
    signinModal.addEventListener('click', (e) => {
        if (e.target === signinModal) {
            signinModal.classList.remove('active');
        }
    });
    
    // Sign-in tabs
    document.querySelectorAll('.signin-tab-btn').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.signin-tab-btn').forEach(t => {
                t.classList.remove('active');
                t.style.borderBottom = 'none';
                t.style.color = 'var(--gray)';
            });
            tab.classList.add('active');
            tab.style.borderBottom = '3px solid var(--accent)';
            tab.style.color = 'var(--primary)';
            
            document.getElementById('adminSigninForm').classList.toggle('hidden', tab.dataset.tab !== 'admin');
            document.getElementById('clubSigninForm').classList.toggle('hidden', tab.dataset.tab !== 'club');
        });
    });
    
    // Admin sign-in
    document.getElementById('adminSigninBtn').addEventListener('click', () => {
        const username = document.getElementById('adminUsername').value;
        const password = document.getElementById('adminPassword').value;
        
        if (username && password) {
            if (username === "admin") {
                signinModal.classList.remove('active');
                document.body.style.overflow = 'hidden';
                adminDashboard.classList.remove('hidden');
                
                // Update sign-in button
                signinBtn.innerHTML = `<i class="fas fa-user-shield"></i> Admin`;
                signinBtn.style.background = 'linear-gradient(135deg, #00c853, #64dd17)';
                signinBtn.style.color = 'white';
                
                // Initialize admin dashboard navigation
                setupAdminDashboard();
            } else {
                alert('Invalid admin credentials. Try "admin" as username with any password.');
            }
        } else {
            alert('Please enter admin username and password');
        }
    });
    
    // Club sign-in
    document.getElementById('clubSigninBtn').addEventListener('click', () => {
        const clubId = document.getElementById('clubId').value.toLowerCase();
        const password = document.getElementById('clubPassword').value;
        
        if (clubId && password) {
            // Find club in database
            const club = platformData.clubs.find(c => c.id === clubId);
            
            if (club && club.password === password) {
                currentClub = club;
                signinModal.classList.remove('active');
                document.body.style.overflow = 'hidden';
                clubDashboard.classList.remove('hidden');
                
                // Update club name in dashboard
                document.getElementById('clubName').textContent = `${club.name} Dashboard`;
                document.getElementById('clubTitle').textContent = `${club.name} Dashboard`;
                document.getElementById('clubHeaderName').textContent = club.name;
                document.getElementById('clubDescription').textContent = club.description || '';
                
                // Update sign-in button
                signinBtn.innerHTML = `<i class="fas fa-users"></i> ${club.name}`;
                signinBtn.style.background = 'linear-gradient(135deg, #ff9100, #ffab00)';
                signinBtn.style.color = 'white';
                
                // Load club data
                loadClubDashboard(club);
                
                // Initialize club dashboard navigation
                setupClubDashboard();
            } else {
                alert('Invalid club credentials. Try: techclub, artists, sports, or science with password "password123"');
            }
        } else {
            alert('Please enter club ID and password');
        }
    });
    
    // Load club dashboard data
    function loadClubDashboard(club) {
        // ... (keep existing club dashboard loading code)
        // This function remains the same as before
    }
    
    // Admin dashboard navigation setup
    function setupAdminDashboard() {
        // Admin nav items
        document.querySelectorAll('.admin-nav-item[data-admin-section]').forEach(item => {
            item.addEventListener('click', () => {
                // Remove active class from all
                document.querySelectorAll('.admin-nav-item').forEach(i => i.classList.remove('active'));
                // Add active to clicked
                item.classList.add('active');
                
                // Show appropriate content
                const section = item.dataset.adminSection;
                
                // Hide all content sections first
                document.getElementById('adminDashboardContent').classList.add('hidden');
                document.getElementById('adminManageBulletins')?.classList.add('hidden');
                document.getElementById('adminManageStories')?.classList.add('hidden');
                document.getElementById('adminManageCardSets')?.classList.add('hidden');
                
                // Show selected section
                if (section === 'dashboard') {
                    document.getElementById('adminDashboardContent').classList.remove('hidden');
                } else if (section === 'bulletins') {
                    document.getElementById('adminManageBulletins')?.classList.remove('hidden');
                } else if (section === 'stories') {
                    document.getElementById('adminManageStories')?.classList.remove('hidden');
                } else if (section === 'cardsets') {
                    document.getElementById('adminManageCardSets')?.classList.remove('hidden');
                }
            });
        });
    }
    
    // Club dashboard navigation setup
    function setupClubDashboard() {
        // Club nav items
        document.querySelectorAll('.admin-nav-item[data-club-section]').forEach(item => {
            item.addEventListener('click', () => {
                // Remove active class from all
                document.querySelectorAll('.admin-nav-item').forEach(i => i.classList.remove('active'));
                // Add active to clicked
                item.classList.add('active');
                
                // Show appropriate content
                const section = item.dataset.clubSection;
                
                // Hide all content sections first
                document.getElementById('clubDashboardContent').classList.add('hidden');
                document.getElementById('clubMembers')?.classList.add('hidden');
                document.getElementById('clubHistory')?.classList.add('hidden');
                document.getElementById('clubActivities')?.classList.add('hidden');
                document.getElementById('clubSettings')?.classList.add('hidden');
                
                // Show selected section
                if (section === 'home') {
                    document.getElementById('clubDashboardContent').classList.remove('hidden');
                } else if (section === 'members') {
                    document.getElementById('clubMembers').classList.remove('hidden');
                    loadMembersSection();
                } else if (section === 'history') {
                    document.getElementById('clubHistory').classList.remove('hidden');
                    loadHistorySection();
                } else if (section === 'activities') {
                    document.getElementById('clubActivities').classList.remove('hidden');
                    loadActivitiesSection();
                } else if (section === 'settings') {
                    document.getElementById('clubSettings').classList.remove('hidden');
                }
            });
        });
        
        // ... (keep existing club dashboard setup code)
        // The rest of the club dashboard functions remain the same
    }
    
    // Logout functionality
    document.getElementById('logoutAdmin')?.addEventListener('click', () => {
        adminDashboard.classList.add('hidden');
        document.body.style.overflow = '';
        signinBtn.innerHTML = `<i class="fas fa-sign-in-alt"></i> Sign In`;
        signinBtn.style.background = '';
        signinBtn.style.color = 'white';
    });
    
    document.getElementById('logoutClub')?.addEventListener('click', () => {
        clubDashboard.classList.add('hidden');
        document.body.style.overflow = '';
        signinBtn.innerHTML = `<i class="fas fa-sign-in-alt"></i> Sign In`;
        signinBtn.style.background = '';
        signinBtn.style.color = 'white';
        currentClub = null;
    });
    
    // Admin and club links in footer
    document.getElementById('adminLinkFooter').addEventListener('click', (e) => {
        e.preventDefault();
        signinModal.classList.add('active');
        document.querySelector('.signin-tab-btn[data-tab="admin"]').click();
    });
    
    document.getElementById('clubLinkFooter').addEventListener('click', (e) => {
        e.preventDefault();
        signinModal.classList.add('active');
        document.querySelector('.signin-tab-btn[data-tab="club"]').click();
    });
    
    // Search functionality
    document.querySelector('.search-input').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
            const query = e.target.value.toLowerCase().trim();
            if (query) {
                // Search across all content types
                const results = [];
                
                // Search bulletins
                platformData.bulletins.forEach(b => {
                    if (b.title.toLowerCase().includes(query) || 
                        b.type.toLowerCase().includes(query)) {
                        results.push(`Bulletin ${b.id}: ${b.title}`);
                    }
                });
                
                // Search stories
                platformData.stories.forEach(s => {
                    if (s.title.toLowerCase().includes(query) || 
                        s.content.toLowerCase().includes(query)) {
                        results.push(`Story ${s.id}: ${s.title}`);
                    }
                });
                
                // Search clubs
                platformData.clubs.forEach(c => {
                    if (c.name.toLowerCase().includes(query) || 
                        c.description.toLowerCase().includes(query)) {
                        results.push(`Club: ${c.name}`);
                    }
                });
                
                if (results.length > 0) {
                    alert(`Search results for "${query}":\n\n${results.slice(0, 5).join('\n')}${results.length > 5 ? '\n\n... and ' + (results.length - 5) + ' more' : ''}`);
                } else {
                    alert(`No results found for "${query}"`);
                }
            }
        }
    });
    
    // Adjust visible pearls based on screen size
    function adjustVisiblePearls() {
        if (window.innerWidth < 768) {
            visiblePearls = 3;
        } else if (window.innerWidth < 1200) {
            visiblePearls = 4;
        } else {
            visiblePearls = 5;
        }
        positionPearls();
    }
    
    // Add reload button to header
    function addReloadButton() {
        const headerActions = document.querySelector('.header-actions');
        const reloadBtn = document.createElement('button');
        reloadBtn.className = 'signin-btn';
        reloadBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Reload Data';
        reloadBtn.style.background = 'linear-gradient(135deg, #3949ab, #1a237e)';
        reloadBtn.style.marginRight = '1rem';
        reloadBtn.title = 'Reload data from database';
        
        reloadBtn.addEventListener('click', () => {
            reloadFromDatabase();
            showNotification('Data reloaded from database!', 'success');
        });
        
        headerActions.insertBefore(reloadBtn, headerActions.firstChild);
    }

    // Function to show the modal
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }
    }

    // Function to hide the modal
    function hideModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
        }
    }
    
    // Notification system
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            background: ${type === 'success' ? '#00c853' : type === 'error' ? '#ff4081' : '#3949ab'};
            animation: slideIn 0.3s ease;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
        
        // Add animation styles
        if (!document.querySelector('#notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
    }
    
    // Initialize everything
    // Initialize everything
function initialize() {
    addReloadButton();
    initializeNecklace();
    updateDisplay(activeBulletin);
    updateNavigationStates();
    startAutoRotate();
    
    // Adjust on window resize
    window.addEventListener('resize', adjustVisiblePearls);
    
    adjustVisiblePearls();
    
    console.log("CenterNecklace Platform initialized with database integration");
    console.log("Total bulletins:", platformData.bulletins.length);
    console.log("Total stories:", platformData.stories.length);
    console.log("Total clubs:", platformData.clubs.length);
    
    // Listen for database changes from other tabs
    window.addEventListener('storage', function(e) {
        if (e.key === 'centerNecklaceDatabase') {
            // Show a notification that data was updated
            showNotification('Database updated from another tab. Refreshing data...', 'info');
            
            // Reload the data after a short delay
            setTimeout(() => {
                if (window.location.pathname.includes('database.html')) {
                    // If we're on the database page, let it handle its own reload
                    return;
                } else {
                    reloadFromDatabase();
                }
            }, 500);
        }
    });

        // Setup event listeners
        setupDynamicEventListeners();
}

    // Function to preview picture using relative path
    function previewPicturePath(picturePath) {
        const modalContent = `
            <div style="text-align: center;">
                <img src="${picturePath}" 
                    alt="Event Picture"
                    style="max-width: 100%; max-height: 70vh; border-radius: 5px;"
                    onerror="this.src='https://via.placeholder.com/600x400?text=Picture+Not+Found'">
                <div style="margin-top: 1rem; text-align: left;">
                    <p><strong>Path:</strong> ${picturePath}</p>
                    <p><strong>File:</strong> ${picturePath.split('/').pop()}</p>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn" onclick="closePicturePreview()" style="padding: 0.8rem 1.5rem;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        `;
        
        const modal = document.createElement('div');
        modal.id = 'picturePreviewModal';
        modal.className = 'modal active';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                ${modalContent}
            </div>
        `;
        document.body.appendChild(modal);
    }

    // Helper function to get all cards from multiple card sets
    function getAllCardsFromSets(cardSetIds) {
        if (!cardSetIds || !Array.isArray(cardSetIds)) return [];
        
        const allCards = [];
        cardSetIds.forEach(setId => {
            const cardSet = platformData.cardSets.find(cs => cs.id === setId);
            if (cardSet && cardSet.cards) {
                // Add card set identifier to each card for reference
                const cardsWithSet = cardSet.cards.map(card => ({
                    ...card,
                    sourceSetId: setId,
                    sourceSetName: cardSet.name
                }));
                allCards.push(...cardsWithSet);
            }
        });
        
        return allCards;
    }

    
    // Start the application
    initialize();

    // Simple unified event delegation
document.addEventListener('click', function(event) {
    // Handle picture clicks
    const pictureElement = event.target.closest('.card-picture');
    if (pictureElement) {
        event.preventDefault();
        event.stopPropagation();
        
        const name = pictureElement.getAttribute('data-card-name');
        const title = pictureElement.getAttribute('data-card-title');
        const introduction = pictureElement.getAttribute('data-card-intro');
        const pictureUrl = pictureElement.getAttribute('data-picture-url');
        
        if (name && pictureUrl) {
            enlargeCardPicture(event, name, title, introduction, pictureUrl);
        }
        return;
    }
    
    // Handle card clicks
    const cardElement = event.target.closest('.card.clickable');
    if (cardElement) {
        event.preventDefault();
        event.stopPropagation();
        
        // Check for donation data
        const donationData = cardElement.getAttribute('data-donation');
        const donationYear = cardElement.getAttribute('data-year');
        
        if (donationData && donationYear) {
            try {
                const donation = JSON.parse(donationData.replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
                showDonationDetails(donation, parseInt(donationYear));
                return;
            } catch (e) {
                console.error('Error parsing donation:', e);
            }
        }
        
        // Check for event data
        const eventData = cardElement.getAttribute('data-event');
        const eventYear = cardElement.getAttribute('data-year');
        
        if (eventData && eventYear) {
            try {
                const eventObj = JSON.parse(eventData.replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
                showEventDetails(eventObj, parseInt(eventYear));
                return;
            } catch (e) {
                console.error('Error parsing event:', e);
            }
        }
        
        // Check for regular card data
        const cardDataStr = cardElement.getAttribute('data-card');
        if (cardDataStr) {
            try {
                const card = JSON.parse(cardDataStr.replace(/&#39;/g, "'"));
                showCardDetails(card);
                return;
            } catch (e) {
                console.error('Error parsing card:', e);
            }
        }
    }
    
    // Handle clickable items
    const clickableItem = event.target.closest('.clickable-item');
    if (clickableItem) {
        event.preventDefault();
        event.stopPropagation();
        
        // Check for donation items
        if (clickableItem.classList.contains('donation-item')) {
            const donationData = clickableItem.getAttribute('data-donation');
            const year = clickableItem.getAttribute('data-year');
            
            if (donationData && year) {
                try {
                    const donation = JSON.parse(donationData.replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
                    showDonationDetails(donation, parseInt(year));
                } catch (e) {
                    console.error('Error parsing donation:', e);
                }
            }
            return;
        }
        
        // Check for event items
        if (clickableItem.classList.contains('event-item')) {
            const eventData = clickableItem.getAttribute('data-event');
            const year = clickableItem.getAttribute('data-year');
            
            if (eventData && year) {
                try {
                    const eventObj = JSON.parse(eventData.replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
                    showEventDetails(eventObj, parseInt(year));
                } catch (e) {
                    console.error('Error parsing event:', e);
                }
            }
            return;
        }
    }
});

// Setup modal close buttons
document.addEventListener('DOMContentLoaded', function() {
    const closeDetailsBtn = document.getElementById('closeDetailsModal');
    if (closeDetailsBtn) {
        closeDetailsBtn.addEventListener('click', closeDetailsModal);
    }
    
    const closeImageBtn = document.getElementById('closeImagePreview');
    if (closeImageBtn) {
        closeImageBtn.addEventListener('click', closeImagePreview);
    }
    
    // Close modals when clicking outside
    document.addEventListener('click', function(event) {
        const detailsModal = document.getElementById('detailsModal');
        if (detailsModal && !detailsModal.classList.contains('hidden') && 
            event.target === detailsModal) {
            closeDetailsModal();
        }
        
        const imageModal = document.getElementById('imagePreviewModal');
        if (imageModal && !imageModal.classList.contains('hidden') && 
            event.target === imageModal) {
            closeImagePreview();
        }
    });
    
    // Close with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeDetailsModal();
            closeImagePreview();
        }
    });
});
    
    // Add event listener for close button
    document.addEventListener('DOMContentLoaded', function() {
        const closeBtn = document.getElementById('closeImagePreview');
        if (closeBtn) {
            closeBtn.addEventListener('click', closeImagePreview);
        }
        
        // Close with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImagePreview();
            }
        });
    })
</script>
</body>
</html>
